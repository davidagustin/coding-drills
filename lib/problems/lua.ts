/**
 * Lua coding drill problems
 * Covers Table Operations, String Functions, Math Functions, Iterator Functions, and Pattern Matching
 */

import type { Problem } from '../types';

export const luaProblems: Problem[] = [
  // ============================================================
  // Table Operations (11 problems: 4 easy, 4 medium, 3 hard)
  // ============================================================

  // table.insert
  {
    id: 'lua-table-001',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Insert Element at End',
    text: 'Use `table.insert` to add the number 4 to the end of the table.',
    setup: 'local numbers = {1, 2, 3}',
    setupCode: 'local numbers = {1, 2, 3}',
    expected: [1, 2, 3, 4],
    sample: 'table.insert(numbers, 4); return numbers',
    hints: ['table.insert(t, value) adds to end', 'The table is modified in place'],
    validPatterns: [/table\.insert\s*\(\s*numbers\s*,\s*4\s*\)/],
    tags: ['table.insert', 'append'],
  },
  {
    id: 'lua-table-002',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Insert Element at Position',
    text: 'Use `table.insert` to add the number 10 at index 2.',
    setup: 'local numbers = {1, 2, 3}',
    setupCode: 'local numbers = {1, 2, 3}',
    expected: [1, 10, 2, 3],
    sample: 'table.insert(numbers, 2, 10); return numbers',
    hints: ['table.insert(t, pos, value) inserts at position', 'Elements shift to make room'],
    validPatterns: [/table\.insert\s*\(\s*numbers\s*,\s*2\s*,\s*10\s*\)/],
    tags: ['table.insert', 'position'],
  },

  // table.remove
  {
    id: 'lua-table-003',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Remove Last Element',
    text: 'Use `table.remove` to remove and return the last element from the table.',
    setup: 'local numbers = {1, 2, 3, 4}',
    setupCode: 'local numbers = {1, 2, 3, 4}',
    expected: 4,
    sample: 'return table.remove(numbers)',
    hints: ['table.remove(t) removes the last element', 'Returns the removed element'],
    validPatterns: [/table\.remove\s*\(\s*numbers\s*\)/],
    tags: ['table.remove', 'pop'],
  },
  {
    id: 'lua-table-004',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Remove Element at Position',
    text: 'Use `table.remove` to remove and return the element at index 2.',
    setup: 'local numbers = {10, 20, 30, 40}',
    setupCode: 'local numbers = {10, 20, 30, 40}',
    expected: 20,
    sample: 'return table.remove(numbers, 2)',
    hints: ['table.remove(t, pos) removes at position', 'Elements shift after removal'],
    validPatterns: [/table\.remove\s*\(\s*numbers\s*,\s*2\s*\)/],
    tags: ['table.remove', 'position'],
  },

  // table.sort
  {
    id: 'lua-table-005',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Sort Table Ascending',
    text: 'Use `table.sort` to sort the numbers in ascending order.',
    setup: 'local numbers = {5, 2, 8, 1, 9}',
    setupCode: 'local numbers = {5, 2, 8, 1, 9}',
    expected: [1, 2, 5, 8, 9],
    sample: 'table.sort(numbers); return numbers',
    hints: ['table.sort(t) sorts in ascending order', 'The table is sorted in place'],
    validPatterns: [/table\.sort\s*\(\s*numbers\s*\)/],
    tags: ['table.sort', 'ascending'],
  },
  {
    id: 'lua-table-006',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Sort Table Descending',
    text: 'Use `table.sort` with a comparison function to sort numbers in descending order.',
    setup: 'local numbers = {5, 2, 8, 1, 9}',
    setupCode: 'local numbers = {5, 2, 8, 1, 9}',
    expected: [9, 8, 5, 2, 1],
    sample: 'table.sort(numbers, function(a, b) return a > b end); return numbers',
    hints: ['table.sort(t, comp) uses custom comparison', 'Return true if a should come before b'],
    validPatterns: [
      /table\.sort\s*\(\s*numbers\s*,\s*function\s*\(\s*\w+\s*,\s*\w+\s*\)\s*return\s+\w+\s*>\s*\w+/,
    ],
    tags: ['table.sort', 'descending', 'comparator'],
  },
  {
    id: 'lua-table-007',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Sort Strings by Length',
    text: 'Use `table.sort` to sort words by their length (shortest first).',
    setup: 'local words = {"apple", "hi", "banana", "cat"}',
    setupCode: 'local words = {"apple", "hi", "banana", "cat"}',
    expected: ['hi', 'cat', 'apple', 'banana'],
    sample: 'table.sort(words, function(a, b) return #a < #b end); return words',
    hints: ['Use # operator to get string length', 'Compare lengths in the function'],
    validPatterns: [
      /table\.sort\s*\(\s*words\s*,\s*function\s*\(\s*\w+\s*,\s*\w+\s*\)\s*return\s+#\w+\s*<\s*#\w+/,
    ],
    tags: ['table.sort', 'length', 'strings'],
  },

  // table.concat
  {
    id: 'lua-table-008',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Concatenate Table Elements',
    text: 'Use `table.concat` to join the words with a space separator.',
    setup: 'local words = {"hello", "world", "lua"}',
    setupCode: 'local words = {"hello", "world", "lua"}',
    expected: 'hello world lua',
    sample: 'return table.concat(words, " ")',
    hints: ['table.concat(t, sep) joins elements', 'Second argument is the separator'],
    validPatterns: [/table\.concat\s*\(\s*words\s*,\s*["'] ["']\s*\)/],
    tags: ['table.concat', 'join'],
  },
  {
    id: 'lua-table-009',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Concatenate Range',
    text: 'Use `table.concat` to join only elements from index 2 to 4.',
    setup: 'local letters = {"a", "b", "c", "d", "e"}',
    setupCode: 'local letters = {"a", "b", "c", "d", "e"}',
    expected: 'b-c-d',
    sample: 'return table.concat(letters, "-", 2, 4)',
    hints: ['table.concat(t, sep, i, j) joins range', 'i and j are start and end indices'],
    validPatterns: [/table\.concat\s*\(\s*letters\s*,\s*["']-["']\s*,\s*2\s*,\s*4\s*\)/],
    tags: ['table.concat', 'range'],
  },

  // # length operator
  {
    id: 'lua-table-010',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Build Table from Scratch',
    text: 'Create a table containing numbers 1 to 5 using a loop and table.insert.',
    setup: 'local result = {}',
    setupCode: 'local result = {}',
    expected: [1, 2, 3, 4, 5],
    sample: 'for i = 1, 5 do table.insert(result, i) end; return result',
    hints: ['Use a for loop from 1 to 5', 'Insert each number into the table'],
    validPatterns: [/for\s+\w+\s*=\s*1\s*,\s*5/, /table\.insert/],
    tags: ['table.insert', 'loop', 'build'],
  },
  {
    id: 'lua-table-011',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Reverse Table In Place',
    text: 'Reverse the table in place using table operations.',
    setup: 'local numbers = {1, 2, 3, 4, 5}',
    setupCode: 'local numbers = {1, 2, 3, 4, 5}',
    expected: [5, 4, 3, 2, 1],
    sample:
      'for i = 1, math.floor(#numbers / 2) do numbers[i], numbers[#numbers - i + 1] = numbers[#numbers - i + 1], numbers[i] end; return numbers',
    hints: ['Swap elements from ends toward middle', 'Use multiple assignment for swapping'],
    validPatterns: [/numbers\[.*\]\s*,\s*numbers\[.*\]\s*=\s*numbers\[.*\]\s*,\s*numbers\[.*\]/],
    tags: ['table', 'reverse', 'swap'],
  },

  // ============================================================
  // String Functions (15 problems: 6 easy, 6 medium, 3 hard)
  // ============================================================

  // string.len
  {
    id: 'lua-string-001',
    category: 'String Functions',
    difficulty: 'easy',
    title: 'Get String Length',
    text: 'Use `string.len` to get the length of the string.',
    setup: 'local text = "hello world"',
    setupCode: 'local text = "hello world"',
    expected: 11,
    sample: 'return string.len(text)',
    hints: ['string.len returns byte length', 'Can also use #text'],
    validPatterns: [/string\.len\s*\(\s*text\s*\)/, /#text/],
    tags: ['string.len', 'length'],
  },

  // string.sub
  {
    id: 'lua-string-002',
    category: 'String Functions',
    difficulty: 'easy',
    title: 'Extract Substring',
    text: 'Use `string.sub` to extract characters from index 1 to 5.',
    setup: 'local text = "hello world"',
    setupCode: 'local text = "hello world"',
    expected: 'hello',
    sample: 'return string.sub(text, 1, 5)',
    hints: ['string.sub(s, i, j) extracts substring', 'Lua strings are 1-indexed'],
    validPatterns: [
      /string\.sub\s*\(\s*text\s*,\s*1\s*,\s*5\s*\)/,
      /text:sub\s*\(\s*1\s*,\s*5\s*\)/,
    ],
    tags: ['string.sub', 'substring'],
  },
  {
    id: 'lua-string-003',
    category: 'String Functions',
    difficulty: 'medium',
    title: 'Get Last Characters',
    text: 'Use `string.sub` with negative index to get the last 3 characters.',
    setup: 'local text = "programming"',
    setupCode: 'local text = "programming"',
    expected: 'ing',
    sample: 'return string.sub(text, -3)',
    hints: ['Negative indices count from end', '-3 means 3rd from last'],
    validPatterns: [/string\.sub\s*\(\s*text\s*,\s*-3\s*\)/, /text:sub\s*\(\s*-3\s*\)/],
    tags: ['string.sub', 'negative index'],
  },

  // string.upper / string.lower
  {
    id: 'lua-string-004',
    category: 'String Functions',
    difficulty: 'easy',
    title: 'Convert to Uppercase',
    text: 'Use `string.upper` to convert the string to uppercase.',
    setup: 'local text = "hello"',
    setupCode: 'local text = "hello"',
    expected: 'HELLO',
    sample: 'return string.upper(text)',
    hints: ['string.upper converts all to uppercase', 'Can use text:upper() method syntax'],
    validPatterns: [/string\.upper\s*\(\s*text\s*\)/, /text:upper\s*\(\s*\)/],
    tags: ['string.upper', 'uppercase'],
  },
  {
    id: 'lua-string-005',
    category: 'String Functions',
    difficulty: 'easy',
    title: 'Convert to Lowercase',
    text: 'Use `string.lower` to convert the string to lowercase.',
    setup: 'local text = "HELLO WORLD"',
    setupCode: 'local text = "HELLO WORLD"',
    expected: 'hello world',
    sample: 'return string.lower(text)',
    hints: ['string.lower converts all to lowercase', 'Can use text:lower() method syntax'],
    validPatterns: [/string\.lower\s*\(\s*text\s*\)/, /text:lower\s*\(\s*\)/],
    tags: ['string.lower', 'lowercase'],
  },

  // string.find
  {
    id: 'lua-string-006',
    category: 'String Functions',
    difficulty: 'easy',
    title: 'Find Substring Position',
    text: 'Use `string.find` to find the starting position of "world".',
    setup: 'local text = "hello world"',
    setupCode: 'local text = "hello world"',
    expected: 7,
    sample: 'local start = string.find(text, "world"); return start',
    hints: ['string.find returns start and end positions', 'Returns nil if not found'],
    validPatterns: [
      /string\.find\s*\(\s*text\s*,\s*["']world["']\s*\)/,
      /text:find\s*\(\s*["']world["']\s*\)/,
    ],
    tags: ['string.find', 'search'],
  },
  {
    id: 'lua-string-007',
    category: 'String Functions',
    difficulty: 'medium',
    title: 'Find with Plain Text',
    text: 'Use `string.find` with plain text mode to find the literal ".".',
    setup: 'local text = "version 1.0.3"',
    setupCode: 'local text = "version 1.0.3"',
    expected: 10,
    sample: 'local start = string.find(text, ".", 1, true); return start',
    hints: ['Fourth argument enables plain text mode', 'Dot is a pattern character normally'],
    validPatterns: [/string\.find\s*\(\s*text\s*,\s*["']\.["']\s*,\s*\d+\s*,\s*true\s*\)/],
    tags: ['string.find', 'plain'],
  },

  // string.gsub
  {
    id: 'lua-string-008',
    category: 'String Functions',
    difficulty: 'medium',
    title: 'Replace All Occurrences',
    text: 'Use `string.gsub` to replace all spaces with underscores.',
    setup: 'local text = "hello world lua"',
    setupCode: 'local text = "hello world lua"',
    expected: 'hello_world_lua',
    sample: 'return (string.gsub(text, " ", "_"))',
    hints: ['string.gsub replaces all occurrences', 'Returns new string and count'],
    validPatterns: [
      /string\.gsub\s*\(\s*text\s*,\s*["'] ["']\s*,\s*["']_["']\s*\)/,
      /text:gsub\s*\(\s*["'] ["']\s*,\s*["']_["']\s*\)/,
    ],
    tags: ['string.gsub', 'replace'],
  },
  {
    id: 'lua-string-009',
    category: 'String Functions',
    difficulty: 'medium',
    title: 'Replace with Limit',
    text: 'Use `string.gsub` to replace only the first 2 occurrences of "a" with "X".',
    setup: 'local text = "banana"',
    setupCode: 'local text = "banana"',
    expected: 'bXnXna',
    sample: 'return (string.gsub(text, "a", "X", 2))',
    hints: ['Fourth argument limits replacements', 'gsub returns (result, count)'],
    validPatterns: [/string\.gsub\s*\(\s*text\s*,\s*["']a["']\s*,\s*["']X["']\s*,\s*2\s*\)/],
    tags: ['string.gsub', 'limit'],
  },

  // string.match
  {
    id: 'lua-string-010',
    category: 'String Functions',
    difficulty: 'medium',
    title: 'Extract First Match',
    text: 'Use `string.match` to extract the first number from the string.',
    setup: 'local text = "price: 42 dollars"',
    setupCode: 'local text = "price: 42 dollars"',
    expected: '42',
    sample: 'return string.match(text, "%d+")',
    hints: ['string.match returns captured text', '%d+ matches one or more digits'],
    validPatterns: [
      /string\.match\s*\(\s*text\s*,\s*["']%d\+["']\s*\)/,
      /text:match\s*\(\s*["']%d\+["']\s*\)/,
    ],
    tags: ['string.match', 'pattern'],
  },

  // string.format
  {
    id: 'lua-string-011',
    category: 'String Functions',
    difficulty: 'easy',
    title: 'Format String with Values',
    text: 'Use `string.format` to create "Name: Alice, Age: 25".',
    setup: 'local name = "Alice"\nlocal age = 25',
    setupCode: 'local name = "Alice"\nlocal age = 25',
    expected: 'Name: Alice, Age: 25',
    sample: 'return string.format("Name: %s, Age: %d", name, age)',
    hints: ['%s for strings, %d for integers', 'Similar to C printf format'],
    validPatterns: [
      /string\.format\s*\(\s*["']Name:\s*%s,\s*Age:\s*%d["']\s*,\s*name\s*,\s*age\s*\)/,
    ],
    tags: ['string.format', 'sprintf'],
  },
  {
    id: 'lua-string-012',
    category: 'String Functions',
    difficulty: 'medium',
    title: 'Format Floating Point',
    text: 'Use `string.format` to format the number with 2 decimal places.',
    setup: 'local pi = 3.14159265',
    setupCode: 'local pi = 3.14159265',
    expected: '3.14',
    sample: 'return string.format("%.2f", pi)',
    hints: ['%.2f formats with 2 decimal places', 'f is for floating point numbers'],
    validPatterns: [/string\.format\s*\(\s*["']%.2f["']\s*,\s*pi\s*\)/],
    tags: ['string.format', 'float'],
  },

  // string.rep
  {
    id: 'lua-string-013',
    category: 'String Functions',
    difficulty: 'hard',
    title: 'Build Separator Line',
    text: 'Use `string.rep` and `string.format` to create "---[TITLE]---".',
    setup: 'local title = "TITLE"',
    setupCode: 'local title = "TITLE"',
    expected: '---[TITLE]---',
    sample: 'return string.format("%s[%s]%s", string.rep("-", 3), title, string.rep("-", 3))',
    hints: ['Combine rep and format', 'rep creates repeated characters'],
    validPatterns: [/string\.rep\s*\(\s*["']-["']\s*,\s*3\s*\)/, /string\.format/],
    tags: ['string.rep', 'string.format'],
  },

  // string.reverse
  {
    id: 'lua-string-014',
    category: 'String Functions',
    difficulty: 'hard',
    title: 'Check Palindrome',
    text: 'Use `string.reverse` and `string.lower` to check if the word is a palindrome.',
    setup: 'local word = "Level"',
    setupCode: 'local word = "Level"',
    expected: true,
    sample: 'local lower = string.lower(word); return lower == string.reverse(lower)',
    hints: ['Convert to lowercase first', 'Compare with reversed version'],
    validPatterns: [/string\.reverse/, /string\.lower/],
    tags: ['string.reverse', 'string.lower', 'palindrome'],
  },
  {
    id: 'lua-string-015',
    category: 'String Functions',
    difficulty: 'hard',
    title: 'Extract File Extension',
    text: 'Use string functions to extract the file extension from the filename.',
    setup: 'local filename = "document.txt"',
    setupCode: 'local filename = "document.txt"',
    expected: 'txt',
    sample: 'local dot = string.find(filename, ".", 1, true); return string.sub(filename, dot + 1)',
    hints: ['Find the dot position first', 'Extract from dot+1 to end'],
    validPatterns: [/string\.find/, /string\.sub/],
    tags: ['string.find', 'string.sub', 'extension'],
  },

  // ============================================================
  // Math Functions (10 problems: 5 easy, 4 medium, 1 hard)
  // ============================================================

  // math.abs
  {
    id: 'lua-math-001',
    category: 'Math Functions',
    difficulty: 'easy',
    title: 'Absolute Value',
    text: 'Use `math.abs` to get the absolute value of the number.',
    setup: 'local num = -42',
    setupCode: 'local num = -42',
    expected: 42,
    sample: 'return math.abs(num)',
    hints: ['math.abs returns absolute value', 'Removes the negative sign'],
    validPatterns: [/math\.abs\s*\(\s*num\s*\)/],
    tags: ['math.abs', 'absolute'],
  },

  // math.ceil / math.floor
  {
    id: 'lua-math-002',
    category: 'Math Functions',
    difficulty: 'easy',
    title: 'Round Up',
    text: 'Use `math.ceil` to round the number up to the nearest integer.',
    setup: 'local num = 4.3',
    setupCode: 'local num = 4.3',
    expected: 5,
    sample: 'return math.ceil(num)',
    hints: ['math.ceil rounds up to ceiling', 'Always rounds toward positive infinity'],
    validPatterns: [/math\.ceil\s*\(\s*num\s*\)/],
    tags: ['math.ceil', 'round'],
  },
  {
    id: 'lua-math-003',
    category: 'Math Functions',
    difficulty: 'easy',
    title: 'Round Down',
    text: 'Use `math.floor` to round the number down to the nearest integer.',
    setup: 'local num = 4.7',
    setupCode: 'local num = 4.7',
    expected: 4,
    sample: 'return math.floor(num)',
    hints: ['math.floor rounds down to floor', 'Always rounds toward negative infinity'],
    validPatterns: [/math\.floor\s*\(\s*num\s*\)/],
    tags: ['math.floor', 'round'],
  },

  // math.max / math.min
  {
    id: 'lua-math-004',
    category: 'Math Functions',
    difficulty: 'easy',
    title: 'Find Maximum',
    text: 'Use `math.max` to find the largest of the three numbers.',
    setup: 'local a, b, c = 10, 25, 15',
    setupCode: 'local a, b, c = 10, 25, 15',
    expected: 25,
    sample: 'return math.max(a, b, c)',
    hints: ['math.max takes multiple arguments', 'Returns the largest value'],
    validPatterns: [/math\.max\s*\(\s*a\s*,\s*b\s*,\s*c\s*\)/],
    tags: ['math.max', 'maximum'],
  },
  {
    id: 'lua-math-005',
    category: 'Math Functions',
    difficulty: 'easy',
    title: 'Find Minimum',
    text: 'Use `math.min` to find the smallest of the three numbers.',
    setup: 'local a, b, c = 10, 25, 15',
    setupCode: 'local a, b, c = 10, 25, 15',
    expected: 10,
    sample: 'return math.min(a, b, c)',
    hints: ['math.min takes multiple arguments', 'Returns the smallest value'],
    validPatterns: [/math\.min\s*\(\s*a\s*,\s*b\s*,\s*c\s*\)/],
    tags: ['math.min', 'minimum'],
  },

  // math.sqrt
  {
    id: 'lua-math-006',
    category: 'Math Functions',
    difficulty: 'medium',
    title: 'Square Root',
    text: 'Use `math.sqrt` to calculate the square root of the number.',
    setup: 'local num = 64',
    setupCode: 'local num = 64',
    expected: 8,
    sample: 'return math.sqrt(num)',
    hints: ['math.sqrt returns square root', 'Equivalent to num^0.5'],
    validPatterns: [/math\.sqrt\s*\(\s*num\s*\)/, /num\s*\^\s*0\.5/],
    tags: ['math.sqrt', 'root'],
  },

  // math.random
  {
    id: 'lua-math-007',
    category: 'Math Functions',
    difficulty: 'medium',
    title: 'Random Integer in Range',
    text: 'Use `math.random` to generate a random integer between 1 and 10 (inclusive).',
    setup: 'math.randomseed(os.time())',
    setupCode: 'math.randomseed(os.time())',
    expected: 'random 1-10',
    sample: 'return math.random(1, 10)',
    hints: ['math.random(m, n) returns integer in [m, n]', 'Both bounds are inclusive'],
    validPatterns: [/math\.random\s*\(\s*1\s*,\s*10\s*\)/],
    tags: ['math.random', 'random'],
  },

  // math.modf
  {
    id: 'lua-math-008',
    category: 'Math Functions',
    difficulty: 'medium',
    title: 'Get Integer Part',
    text: 'Use `math.modf` to get only the integer part of the number.',
    setup: 'local num = 7.89',
    setupCode: 'local num = 7.89',
    expected: 7,
    sample: 'local int_part = math.modf(num); return int_part',
    hints: ['math.modf returns integer and fractional parts', 'First return value is integer part'],
    validPatterns: [/math\.modf\s*\(\s*num\s*\)/],
    tags: ['math.modf', 'integer'],
  },

  // math.fmod
  {
    id: 'lua-math-009',
    category: 'Math Functions',
    difficulty: 'medium',
    title: 'Float Modulo',
    text: 'Use `math.fmod` to get the remainder of 10.5 divided by 3.',
    setup: 'local a = 10.5\nlocal b = 3',
    setupCode: 'local a = 10.5\nlocal b = 3',
    expected: 1.5,
    sample: 'return math.fmod(a, b)',
    hints: ['math.fmod works with floats', 'Returns remainder with same sign as dividend'],
    validPatterns: [/math\.fmod\s*\(\s*a\s*,\s*b\s*\)/],
    tags: ['math.fmod', 'modulo'],
  },

  // Combined math
  {
    id: 'lua-math-010',
    category: 'Math Functions',
    difficulty: 'hard',
    title: 'Clamp Value',
    text: 'Use `math.max` and `math.min` to clamp the value between 0 and 100.',
    setup: 'local value = 150\nlocal min_val = 0\nlocal max_val = 100',
    setupCode: 'local value = 150\nlocal min_val = 0\nlocal max_val = 100',
    expected: 100,
    sample: 'return math.min(math.max(value, min_val), max_val)',
    hints: ['Use max to enforce lower bound', 'Use min to enforce upper bound'],
    validPatterns: [/math\.min\s*\(.*math\.max/, /math\.max\s*\(.*math\.min/],
    tags: ['math.min', 'math.max', 'clamp'],
  },

  // ============================================================
  // Iterator Functions (8 problems: 3 easy, 4 medium, 1 hard)
  // ============================================================

  // ipairs
  {
    id: 'lua-iter-001',
    category: 'Iterator Functions',
    difficulty: 'easy',
    title: 'Sum with ipairs',
    text: 'Use `ipairs` to iterate and sum all numbers in the table.',
    setup: 'local numbers = {1, 2, 3, 4, 5}',
    setupCode: 'local numbers = {1, 2, 3, 4, 5}',
    expected: 15,
    sample: 'local sum = 0; for _, v in ipairs(numbers) do sum = sum + v end; return sum',
    hints: ['ipairs iterates over array part', 'Gives index and value pairs'],
    validPatterns: [/ipairs\s*\(\s*numbers\s*\)/],
    tags: ['ipairs', 'loop', 'sum'],
  },
  {
    id: 'lua-iter-002',
    category: 'Iterator Functions',
    difficulty: 'easy',
    title: 'Find with ipairs',
    text: 'Use `ipairs` to find the index of the first even number.',
    setup: 'local numbers = {1, 3, 4, 7, 8}',
    setupCode: 'local numbers = {1, 3, 4, 7, 8}',
    expected: 3,
    sample: 'for i, v in ipairs(numbers) do if v % 2 == 0 then return i end end',
    hints: ['ipairs gives index as first value', 'Check each value with modulo'],
    validPatterns: [/ipairs\s*\(\s*numbers\s*\)/],
    tags: ['ipairs', 'find', 'index'],
  },
  {
    id: 'lua-iter-003',
    category: 'Iterator Functions',
    difficulty: 'medium',
    title: 'Double Values with ipairs',
    text: 'Use `ipairs` to create a new table with all values doubled.',
    setup: 'local numbers = {1, 2, 3, 4}',
    setupCode: 'local numbers = {1, 2, 3, 4}',
    expected: [2, 4, 6, 8],
    sample:
      'local result = {}; for i, v in ipairs(numbers) do result[i] = v * 2 end; return result',
    hints: ['Create a new table for results', 'Use the index to set values'],
    validPatterns: [/ipairs\s*\(\s*numbers\s*\)/],
    tags: ['ipairs', 'transform'],
  },

  // pairs
  {
    id: 'lua-iter-004',
    category: 'Iterator Functions',
    difficulty: 'easy',
    title: 'Count Keys with pairs',
    text: 'Use `pairs` to count the number of key-value pairs in the table.',
    setup: 'local person = {name = "Alice", age = 30, city = "NYC"}',
    setupCode: 'local person = {name = "Alice", age = 30, city = "NYC"}',
    expected: 3,
    sample: 'local count = 0; for _ in pairs(person) do count = count + 1 end; return count',
    hints: ['pairs iterates all key-value pairs', 'Increment counter for each pair'],
    validPatterns: [/pairs\s*\(\s*person\s*\)/],
    tags: ['pairs', 'count'],
  },
  {
    id: 'lua-iter-005',
    category: 'Iterator Functions',
    difficulty: 'medium',
    title: 'Collect Keys with pairs',
    text: 'Use `pairs` to collect all keys into a table.',
    setup: 'local person = {name = "Alice", age = 30}',
    setupCode: 'local person = {name = "Alice", age = 30}',
    expected: ['name', 'age'],
    sample: 'local keys = {}; for k in pairs(person) do table.insert(keys, k) end; return keys',
    hints: ['pairs gives key as first value', 'Use table.insert to add keys'],
    validPatterns: [/pairs\s*\(\s*person\s*\)/],
    tags: ['pairs', 'keys'],
  },
  {
    id: 'lua-iter-006',
    category: 'Iterator Functions',
    difficulty: 'medium',
    title: 'Sum Values with pairs',
    text: 'Use `pairs` to sum all numeric values in the table.',
    setup: 'local scores = {alice = 90, bob = 85, carol = 95}',
    setupCode: 'local scores = {alice = 90, bob = 85, carol = 95}',
    expected: 270,
    sample: 'local sum = 0; for _, v in pairs(scores) do sum = sum + v end; return sum',
    hints: ['pairs works with string keys', 'Use _ to ignore the key'],
    validPatterns: [/pairs\s*\(\s*scores\s*\)/],
    tags: ['pairs', 'sum'],
  },

  // next
  {
    id: 'lua-iter-007',
    category: 'Iterator Functions',
    difficulty: 'medium',
    title: 'Check Empty Table with next',
    text: 'Use `next` to check if the table is empty (return true if empty).',
    setup: 'local empty = {}',
    setupCode: 'local empty = {}',
    expected: true,
    sample: 'return next(empty) == nil',
    hints: ['next(t) returns nil for empty tables', 'Compare result with nil'],
    validPatterns: [/next\s*\(\s*empty\s*\)\s*==\s*nil/],
    tags: ['next', 'empty'],
  },
  {
    id: 'lua-iter-008',
    category: 'Iterator Functions',
    difficulty: 'hard',
    title: 'Filter with ipairs',
    text: 'Use `ipairs` to create a new table containing only even numbers.',
    setup: 'local numbers = {1, 2, 3, 4, 5, 6}',
    setupCode: 'local numbers = {1, 2, 3, 4, 5, 6}',
    expected: [2, 4, 6],
    sample:
      'local result = {}; for _, v in ipairs(numbers) do if v % 2 == 0 then table.insert(result, v) end end; return result',
    hints: ['Check if each value is even', 'Use table.insert for matching values'],
    validPatterns: [/ipairs\s*\(\s*numbers\s*\)/, /v\s*%\s*2\s*==\s*0/],
    tags: ['ipairs', 'filter', 'even'],
  },

  // ============================================================
  // Pattern Matching (6 problems: 2 easy, 2 medium, 2 hard)
  // ============================================================

  // Basic patterns
  {
    id: 'lua-pattern-001',
    category: 'Pattern Matching',
    difficulty: 'easy',
    title: 'Match Digits',
    text: 'Use `string.match` to extract all consecutive digits from the string.',
    setup: 'local text = "Order #12345 confirmed"',
    setupCode: 'local text = "Order #12345 confirmed"',
    expected: '12345',
    sample: 'return string.match(text, "%d+")',
    hints: ['%d matches any digit', '+ means one or more'],
    validPatterns: [
      /string\.match\s*\(\s*text\s*,\s*["']%d\+["']\s*\)/,
      /text:match\s*\(\s*["']%d\+["']\s*\)/,
    ],
    tags: ['pattern', 'digits'],
  },
  {
    id: 'lua-pattern-002',
    category: 'Pattern Matching',
    difficulty: 'easy',
    title: 'Match Word Characters',
    text: 'Use `string.match` to extract the first word (letters only).',
    setup: 'local text = "Hello, World!"',
    setupCode: 'local text = "Hello, World!"',
    expected: 'Hello',
    sample: 'return string.match(text, "%a+")',
    hints: ['%a matches any letter', '+ means one or more'],
    validPatterns: [
      /string\.match\s*\(\s*text\s*,\s*["']%a\+["']\s*\)/,
      /text:match\s*\(\s*["']%a\+["']\s*\)/,
    ],
    tags: ['pattern', 'letters'],
  },

  // Captures
  {
    id: 'lua-pattern-003',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Capture Groups',
    text: 'Use `string.match` with captures to extract the area code from the phone number.',
    setup: 'local phone = "(555) 123-4567"',
    setupCode: 'local phone = "(555) 123-4567"',
    expected: '555',
    sample: 'return string.match(phone, "%((%d+)%)")',
    hints: ['Use () to capture', '%( and %) match literal parentheses'],
    validPatterns: [/string\.match\s*\(\s*phone\s*,\s*["'].*%\(.*%d.*%\).*["']\s*\)/],
    tags: ['pattern', 'capture'],
  },
  {
    id: 'lua-pattern-004',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Replace with Pattern',
    text: 'Use `string.gsub` with a pattern to remove all digits from the string.',
    setup: 'local text = "abc123def456"',
    setupCode: 'local text = "abc123def456"',
    expected: 'abcdef',
    sample: 'return (string.gsub(text, "%d+", ""))',
    hints: ['%d+ matches digit sequences', 'Replace with empty string to remove'],
    validPatterns: [/string\.gsub\s*\(\s*text\s*,\s*["']%d\+["']\s*,\s*["']["']\s*\)/],
    tags: ['pattern', 'gsub', 'remove'],
  },

  // gmatch iterator
  {
    id: 'lua-pattern-005',
    category: 'Pattern Matching',
    difficulty: 'hard',
    title: 'Iterate All Matches',
    text: 'Use `string.gmatch` to collect all words into a table.',
    setup: 'local text = "hello world lua programming"',
    setupCode: 'local text = "hello world lua programming"',
    expected: ['hello', 'world', 'lua', 'programming'],
    sample:
      'local words = {}; for word in string.gmatch(text, "%w+") do table.insert(words, word) end; return words',
    hints: ['gmatch returns an iterator', 'Use for loop to collect matches'],
    validPatterns: [
      /string\.gmatch\s*\(\s*text\s*,\s*["']%w\+["']\s*\)/,
      /text:gmatch\s*\(\s*["']%w\+["']\s*\)/,
    ],
    tags: ['pattern', 'gmatch', 'iterator'],
  },
  {
    id: 'lua-pattern-006',
    category: 'Pattern Matching',
    difficulty: 'hard',
    title: 'Replace with Function',
    text: 'Use `string.gsub` with a function to double each number found.',
    setup: 'local text = "I have 5 apples and 3 oranges"',
    setupCode: 'local text = "I have 5 apples and 3 oranges"',
    expected: 'I have 10 apples and 6 oranges',
    sample: 'return (string.gsub(text, "%d+", function(n) return tostring(tonumber(n) * 2) end))',
    hints: ['gsub can take a function', 'Function receives the match as argument'],
    validPatterns: [/string\.gsub\s*\(\s*text\s*,\s*["']%d\+["']\s*,\s*function/],
    tags: ['pattern', 'gsub', 'function'],
  },

  // ============================================================
  // NEW PROBLEMS - Table Operations (50 problems)
  // ============================================================

  {
    id: 'lua-tbl-100',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Create Empty Table',
    text: 'Create an empty table and return it.',
    setup: '',
    setupCode: '',
    expected: {},
    sample: 'local t = {}; return t',
    hints: ['Use {} to create an empty table', 'Tables are the primary data structure in Lua'],
    tags: ['table', 'create'],
  },
  {
    id: 'lua-tbl-101',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Table with Initial Values',
    text: 'Create a table with values 10, 20, 30 and return it.',
    setup: '',
    setupCode: '',
    expected: [10, 20, 30],
    sample: 'return {10, 20, 30}',
    hints: ['List values separated by commas', 'Values are assigned indices 1, 2, 3'],
    tags: ['table', 'create', 'array'],
  },
  {
    id: 'lua-tbl-102',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Access First Element',
    text: 'Return the first element of the table.',
    setup: 'local fruits = {"apple", "banana", "cherry"}',
    setupCode: 'local fruits = {"apple", "banana", "cherry"}',
    expected: 'apple',
    sample: 'return fruits[1]',
    hints: ['Lua arrays are 1-indexed', 'Use bracket notation to access elements'],
    tags: ['table', 'access', 'index'],
  },
  {
    id: 'lua-tbl-103',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Get Table Length',
    text: 'Return the number of elements in the table using the # operator.',
    setup: 'local nums = {1, 2, 3, 4, 5}',
    setupCode: 'local nums = {1, 2, 3, 4, 5}',
    expected: 5,
    sample: 'return #nums',
    hints: ['The # operator returns array length', 'Works on sequential integer keys'],
    tags: ['table', 'length', 'operator'],
  },
  {
    id: 'lua-tbl-104',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Modify Element',
    text: 'Change the second element to "grape" and return the table.',
    setup: 'local fruits = {"apple", "banana", "cherry"}',
    setupCode: 'local fruits = {"apple", "banana", "cherry"}',
    expected: ['apple', 'grape', 'cherry'],
    sample: 'fruits[2] = "grape"; return fruits',
    hints: ['Assign to index to modify', 'Tables are mutable'],
    tags: ['table', 'modify', 'assignment'],
  },
  {
    id: 'lua-tbl-105',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Insert at Beginning',
    text: 'Use table.insert to add "zero" at index 1.',
    setup: 'local items = {"one", "two", "three"}',
    setupCode: 'local items = {"one", "two", "three"}',
    expected: ['zero', 'one', 'two', 'three'],
    sample: 'table.insert(items, 1, "zero"); return items',
    hints: ['table.insert(t, pos, value)', 'Position 1 is the beginning'],
    tags: ['table.insert', 'prepend'],
  },
  {
    id: 'lua-tbl-106',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Remove First Element',
    text: 'Use table.remove to remove and return the first element.',
    setup: 'local queue = {"first", "second", "third"}',
    setupCode: 'local queue = {"first", "second", "third"}',
    expected: 'first',
    sample: 'return table.remove(queue, 1)',
    hints: ['table.remove(t, pos) removes at position', 'Returns the removed element'],
    tags: ['table.remove', 'shift'],
  },
  {
    id: 'lua-tbl-107',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Concatenate with Comma',
    text: 'Use table.concat to join elements with a comma and space.',
    setup: 'local words = {"a", "b", "c"}',
    setupCode: 'local words = {"a", "b", "c"}',
    expected: 'a, b, c',
    sample: 'return table.concat(words, ", ")',
    hints: ['Second argument is separator', 'Returns a string'],
    tags: ['table.concat', 'join'],
  },
  {
    id: 'lua-tbl-108',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Sort Strings Alphabetically',
    text: 'Sort the names table alphabetically.',
    setup: 'local names = {"Charlie", "Alice", "Bob"}',
    setupCode: 'local names = {"Charlie", "Alice", "Bob"}',
    expected: ['Alice', 'Bob', 'Charlie'],
    sample: 'table.sort(names); return names',
    hints: ['Default sort is alphabetical for strings', 'Modifies table in place'],
    tags: ['table.sort', 'alphabetical'],
  },
  {
    id: 'lua-tbl-109',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Sort by Table Field',
    text: 'Sort the people table by age in ascending order.',
    setup: 'local people = {{name="Bob", age=30}, {name="Alice", age=25}, {name="Carol", age=35}}',
    setupCode:
      'local people = {{name="Bob", age=30}, {name="Alice", age=25}, {name="Carol", age=35}}',
    expected: [
      { name: 'Alice', age: 25 },
      { name: 'Bob', age: 30 },
      { name: 'Carol', age: 35 },
    ],
    sample: 'table.sort(people, function(a, b) return a.age < b.age end); return people',
    hints: ['Use comparison function', 'Compare the age fields'],
    tags: ['table.sort', 'objects', 'comparator'],
  },
  {
    id: 'lua-tbl-110',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Copy Array Elements',
    text: 'Create a shallow copy of the numbers table.',
    setup: 'local numbers = {1, 2, 3, 4, 5}',
    setupCode: 'local numbers = {1, 2, 3, 4, 5}',
    expected: [1, 2, 3, 4, 5],
    sample: 'local copy = {}; for i, v in ipairs(numbers) do copy[i] = v end; return copy',
    hints: ['Iterate and copy each element', 'Assignment creates a new table'],
    tags: ['table', 'copy', 'ipairs'],
  },
  {
    id: 'lua-tbl-111',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Merge Two Tables',
    text: 'Append all elements from table b to table a.',
    setup: 'local a = {1, 2, 3}\nlocal b = {4, 5, 6}',
    setupCode: 'local a = {1, 2, 3}\nlocal b = {4, 5, 6}',
    expected: [1, 2, 3, 4, 5, 6],
    sample: 'for _, v in ipairs(b) do table.insert(a, v) end; return a',
    hints: ['Iterate over second table', 'Insert each element into first'],
    tags: ['table', 'merge', 'append'],
  },
  {
    id: 'lua-tbl-112',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Find Element Index',
    text: 'Return the index of value 30 in the table, or nil if not found.',
    setup: 'local nums = {10, 20, 30, 40, 50}',
    setupCode: 'local nums = {10, 20, 30, 40, 50}',
    expected: 3,
    sample: 'for i, v in ipairs(nums) do if v == 30 then return i end end; return nil',
    hints: ['Iterate and compare values', 'Return index when found'],
    tags: ['table', 'find', 'search'],
  },
  {
    id: 'lua-tbl-113',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Remove Duplicates',
    text: 'Create a new table with duplicate values removed.',
    setup: 'local nums = {1, 2, 2, 3, 3, 3, 4}',
    setupCode: 'local nums = {1, 2, 2, 3, 3, 3, 4}',
    expected: [1, 2, 3, 4],
    sample:
      'local seen = {}; local result = {}; for _, v in ipairs(nums) do if not seen[v] then seen[v] = true; table.insert(result, v) end end; return result',
    hints: ['Track seen values with a table', 'Only add if not seen before'],
    tags: ['table', 'unique', 'deduplicate'],
  },
  {
    id: 'lua-tbl-114',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Table Contains Value',
    text: 'Return true if the table contains the value "banana".',
    setup: 'local fruits = {"apple", "banana", "cherry"}',
    setupCode: 'local fruits = {"apple", "banana", "cherry"}',
    expected: true,
    sample: 'for _, v in ipairs(fruits) do if v == "banana" then return true end end; return false',
    hints: ['Iterate and compare', 'Return true on match'],
    tags: ['table', 'contains', 'search'],
  },
  {
    id: 'lua-tbl-115',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Count Occurrences',
    text: 'Count how many times the value 5 appears in the table.',
    setup: 'local nums = {5, 3, 5, 1, 5, 2, 5}',
    setupCode: 'local nums = {5, 3, 5, 1, 5, 2, 5}',
    expected: 4,
    sample:
      'local count = 0; for _, v in ipairs(nums) do if v == 5 then count = count + 1 end end; return count',
    hints: ['Initialize counter to 0', 'Increment when value matches'],
    tags: ['table', 'count', 'frequency'],
  },
  {
    id: 'lua-tbl-116',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Flatten Nested Table',
    text: 'Flatten a table of tables into a single table.',
    setup: 'local nested = {{1, 2}, {3, 4}, {5, 6}}',
    setupCode: 'local nested = {{1, 2}, {3, 4}, {5, 6}}',
    expected: [1, 2, 3, 4, 5, 6],
    sample:
      'local result = {}; for _, inner in ipairs(nested) do for _, v in ipairs(inner) do table.insert(result, v) end end; return result',
    hints: ['Use nested loops', 'Insert each inner element'],
    tags: ['table', 'flatten', 'nested'],
  },
  {
    id: 'lua-tbl-117',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Zip Two Tables',
    text: 'Create a table of pairs from two tables of equal length.',
    setup: 'local keys = {"a", "b", "c"}\nlocal vals = {1, 2, 3}',
    setupCode: 'local keys = {"a", "b", "c"}\nlocal vals = {1, 2, 3}',
    expected: [
      ['a', 1],
      ['b', 2],
      ['c', 3],
    ],
    sample:
      'local result = {}; for i = 1, #keys do result[i] = {keys[i], vals[i]} end; return result',
    hints: ['Iterate by index', 'Create pair tables'],
    tags: ['table', 'zip', 'pairs'],
  },
  {
    id: 'lua-tbl-118',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Group By Property',
    text: 'Group items by their category field.',
    setup: 'local items = {{name="a", cat="x"}, {name="b", cat="y"}, {name="c", cat="x"}}',
    setupCode: 'local items = {{name="a", cat="x"}, {name="b", cat="y"}, {name="c", cat="x"}}',
    expected: {
      x: [
        { name: 'a', cat: 'x' },
        { name: 'c', cat: 'x' },
      ],
      y: [{ name: 'b', cat: 'y' }],
    },
    sample:
      'local groups = {}; for _, item in ipairs(items) do groups[item.cat] = groups[item.cat] or {}; table.insert(groups[item.cat], item) end; return groups',
    hints: ['Create group tables on demand', 'Use category as key'],
    tags: ['table', 'group', 'categorize'],
  },
  {
    id: 'lua-tbl-119',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Rotate Table Left',
    text: 'Rotate the table elements one position to the left.',
    setup: 'local nums = {1, 2, 3, 4, 5}',
    setupCode: 'local nums = {1, 2, 3, 4, 5}',
    expected: [2, 3, 4, 5, 1],
    sample: 'local first = table.remove(nums, 1); table.insert(nums, first); return nums',
    hints: ['Remove first element', 'Insert at end'],
    tags: ['table', 'rotate', 'shift'],
  },
  {
    id: 'lua-tbl-120',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Create Key-Value Table',
    text: 'Create a table with name="Lua" and version=5.4 and return it.',
    setup: '',
    setupCode: '',
    expected: { name: 'Lua', version: 5.4 },
    sample: 'return {name = "Lua", version = 5.4}',
    hints: ['Use key = value syntax', 'Keys can be identifiers'],
    tags: ['table', 'dictionary', 'create'],
  },
  {
    id: 'lua-tbl-121',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Access by String Key',
    text: 'Return the value associated with the key "color".',
    setup: 'local config = {color = "blue", size = 10}',
    setupCode: 'local config = {color = "blue", size = 10}',
    expected: 'blue',
    sample: 'return config.color',
    hints: ['Use dot notation for string keys', 'Or use config["color"]'],
    tags: ['table', 'access', 'key'],
  },
  {
    id: 'lua-tbl-122',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Add New Key',
    text: 'Add a new key "active" with value true to the table.',
    setup: 'local user = {name = "Alice"}',
    setupCode: 'local user = {name = "Alice"}',
    expected: { name: 'Alice', active: true },
    sample: 'user.active = true; return user',
    hints: ['Assign to new key', 'Tables are dynamic'],
    tags: ['table', 'add', 'key'],
  },
  {
    id: 'lua-tbl-123',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Delete Key',
    text: 'Remove the key "temp" from the table by setting it to nil.',
    setup: 'local data = {name = "test", temp = 123}',
    setupCode: 'local data = {name = "test", temp = 123}',
    expected: { name: 'test' },
    sample: 'data.temp = nil; return data',
    hints: ['Setting to nil removes key', 'Key will no longer exist'],
    tags: ['table', 'delete', 'nil'],
  },
  {
    id: 'lua-tbl-124',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Check Key Exists',
    text: 'Return true if the table has a key "email", false otherwise.',
    setup: 'local user = {name = "Bob", email = "bob@example.com"}',
    setupCode: 'local user = {name = "Bob", email = "bob@example.com"}',
    expected: true,
    sample: 'return user.email ~= nil',
    hints: ['Non-existent keys return nil', 'Compare with nil'],
    tags: ['table', 'exists', 'check'],
  },
  {
    id: 'lua-tbl-125',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Get All Keys',
    text: 'Return a table containing all keys from the given table.',
    setup: 'local info = {a = 1, b = 2, c = 3}',
    setupCode: 'local info = {a = 1, b = 2, c = 3}',
    expected: ['a', 'b', 'c'],
    sample:
      'local keys = {}; for k in pairs(info) do table.insert(keys, k) end; table.sort(keys); return keys',
    hints: ['Use pairs to iterate', 'Collect keys into table'],
    tags: ['table', 'keys', 'pairs'],
  },
  {
    id: 'lua-tbl-126',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Get All Values',
    text: 'Return a table containing all values from the given table.',
    setup: 'local scores = {alice = 90, bob = 85, carol = 95}',
    setupCode: 'local scores = {alice = 90, bob = 85, carol = 95}',
    expected: [85, 90, 95],
    sample:
      'local vals = {}; for _, v in pairs(scores) do table.insert(vals, v) end; table.sort(vals); return vals',
    hints: ['Use pairs to iterate', 'Ignore keys with _'],
    tags: ['table', 'values', 'pairs'],
  },
  {
    id: 'lua-tbl-127',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Deep Copy Table',
    text: 'Create a deep copy of the nested table.',
    setup: 'local orig = {a = 1, nested = {b = 2}}',
    setupCode: 'local orig = {a = 1, nested = {b = 2}}',
    expected: { a: 1, nested: { b: 2 } },
    sample:
      'local function deepcopy(t) local copy = {}; for k, v in pairs(t) do if type(v) == "table" then copy[k] = deepcopy(v) else copy[k] = v end end; return copy end; return deepcopy(orig)',
    hints: ['Use recursion for nested tables', 'Check type before copying'],
    tags: ['table', 'deepcopy', 'recursive'],
  },
  {
    id: 'lua-tbl-128',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Invert Table',
    text: 'Create a new table with keys and values swapped.',
    setup: 'local t = {a = 1, b = 2, c = 3}',
    setupCode: 'local t = {a = 1, b = 2, c = 3}',
    expected: { 1: 'a', 2: 'b', 3: 'c' },
    sample: 'local inv = {}; for k, v in pairs(t) do inv[v] = k end; return inv',
    hints: ['Values become keys', 'Keys become values'],
    tags: ['table', 'invert', 'swap'],
  },
  {
    id: 'lua-tbl-129',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Table Difference',
    text: 'Return elements in a that are not in b.',
    setup: 'local a = {1, 2, 3, 4, 5}\nlocal b = {2, 4}',
    setupCode: 'local a = {1, 2, 3, 4, 5}\nlocal b = {2, 4}',
    expected: [1, 3, 5],
    sample:
      'local set = {}; for _, v in ipairs(b) do set[v] = true end; local result = {}; for _, v in ipairs(a) do if not set[v] then table.insert(result, v) end end; return result',
    hints: ['Convert b to a set', 'Filter a by set membership'],
    tags: ['table', 'difference', 'set'],
  },
  {
    id: 'lua-tbl-130',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Table Intersection',
    text: 'Return elements that exist in both tables.',
    setup: 'local a = {1, 2, 3, 4}\nlocal b = {3, 4, 5, 6}',
    setupCode: 'local a = {1, 2, 3, 4}\nlocal b = {3, 4, 5, 6}',
    expected: [3, 4],
    sample:
      'local set = {}; for _, v in ipairs(a) do set[v] = true end; local result = {}; for _, v in ipairs(b) do if set[v] then table.insert(result, v) end end; return result',
    hints: ['Convert first table to set', 'Check membership for second'],
    tags: ['table', 'intersection', 'set'],
  },

  // ============================================================
  // NEW PROBLEMS - String Library (50 problems)
  // ============================================================

  {
    id: 'lua-str-100',
    category: 'String Library',
    difficulty: 'easy',
    title: 'String Concatenation',
    text: 'Concatenate first and last name with a space between.',
    setup: 'local first = "John"\nlocal last = "Doe"',
    setupCode: 'local first = "John"\nlocal last = "Doe"',
    expected: 'John Doe',
    sample: 'return first .. " " .. last',
    hints: ['Use .. for concatenation', 'Add space string between'],
    tags: ['string', 'concat', 'operator'],
  },
  {
    id: 'lua-str-101',
    category: 'String Library',
    difficulty: 'easy',
    title: 'String Byte Value',
    text: 'Return the ASCII value of the first character.',
    setup: 'local s = "Hello"',
    setupCode: 'local s = "Hello"',
    expected: 72,
    sample: 'return string.byte(s, 1)',
    hints: ['string.byte returns ASCII code', 'Second arg is position'],
    tags: ['string.byte', 'ascii'],
  },
  {
    id: 'lua-str-102',
    category: 'String Library',
    difficulty: 'easy',
    title: 'Character from Byte',
    text: 'Return the character for ASCII code 65.',
    setup: 'local code = 65',
    setupCode: 'local code = 65',
    expected: 'A',
    sample: 'return string.char(code)',
    hints: ['string.char converts code to char', '65 is uppercase A'],
    tags: ['string.char', 'ascii'],
  },
  {
    id: 'lua-str-103',
    category: 'String Library',
    difficulty: 'easy',
    title: 'Repeat String',
    text: 'Use string.rep to repeat the string 3 times.',
    setup: 'local s = "ab"',
    setupCode: 'local s = "ab"',
    expected: 'ababab',
    sample: 'return string.rep(s, 3)',
    hints: ['string.rep repeats string', 'Second arg is count'],
    tags: ['string.rep', 'repeat'],
  },
  {
    id: 'lua-str-104',
    category: 'String Library',
    difficulty: 'easy',
    title: 'Reverse String',
    text: 'Reverse the given string.',
    setup: 'local s = "Lua"',
    setupCode: 'local s = "Lua"',
    expected: 'auL',
    sample: 'return string.reverse(s)',
    hints: ['string.reverse reverses string', 'Returns new string'],
    tags: ['string.reverse', 'reverse'],
  },
  {
    id: 'lua-str-105',
    category: 'String Library',
    difficulty: 'easy',
    title: 'Check String Start',
    text: 'Return true if the string starts with "Hello".',
    setup: 'local s = "Hello World"',
    setupCode: 'local s = "Hello World"',
    expected: true,
    sample: 'return string.sub(s, 1, 5) == "Hello"',
    hints: ['Extract first N characters', 'Compare with target'],
    tags: ['string.sub', 'startswith'],
  },
  {
    id: 'lua-str-106',
    category: 'String Library',
    difficulty: 'easy',
    title: 'Check String End',
    text: 'Return true if the string ends with "lua".',
    setup: 'local s = "I love lua"',
    setupCode: 'local s = "I love lua"',
    expected: true,
    sample: 'return string.sub(s, -3) == "lua"',
    hints: ['Negative index counts from end', 'Extract last 3 chars'],
    tags: ['string.sub', 'endswith'],
  },
  {
    id: 'lua-str-107',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Find Last Occurrence',
    text: 'Find the position of the last space in the string.',
    setup: 'local s = "hello world lua"',
    setupCode: 'local s = "hello world lua"',
    expected: 12,
    sample:
      'local pos = 0; local i = 1; while true do local p = string.find(s, " ", i, true); if not p then break end; pos = p; i = p + 1 end; return pos',
    hints: ['Loop through all occurrences', 'Keep track of last position'],
    tags: ['string.find', 'last'],
  },
  {
    id: 'lua-str-108',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Count Substring',
    text: 'Count how many times "a" appears in the string.',
    setup: 'local s = "banana"',
    setupCode: 'local s = "banana"',
    expected: 3,
    sample:
      'local count = 0; for _ in string.gmatch(s, "a") do count = count + 1 end; return count',
    hints: ['Use gmatch to find all', 'Count iterations'],
    tags: ['string.gmatch', 'count'],
  },
  {
    id: 'lua-str-109',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Split String by Delimiter',
    text: 'Split the string by commas into a table.',
    setup: 'local s = "a,b,c,d"',
    setupCode: 'local s = "a,b,c,d"',
    expected: ['a', 'b', 'c', 'd'],
    sample:
      'local result = {}; for part in string.gmatch(s, "[^,]+") do table.insert(result, part) end; return result',
    hints: ['Match non-comma sequences', 'Use character class [^,]'],
    tags: ['string.gmatch', 'split'],
  },
  {
    id: 'lua-str-110',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Trim Whitespace',
    text: 'Remove leading and trailing whitespace from the string.',
    setup: 'local s = "  hello world  "',
    setupCode: 'local s = "  hello world  "',
    expected: 'hello world',
    sample: 'return string.match(s, "^%s*(.-)%s*$")',
    hints: ['Use pattern anchors ^ and $', '%s matches whitespace'],
    tags: ['string.match', 'trim'],
  },
  {
    id: 'lua-str-111',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Capitalize First Letter',
    text: 'Capitalize only the first letter of the string.',
    setup: 'local s = "hello world"',
    setupCode: 'local s = "hello world"',
    expected: 'Hello world',
    sample: 'return string.upper(string.sub(s, 1, 1)) .. string.sub(s, 2)',
    hints: ['Extract and uppercase first char', 'Concatenate with rest'],
    tags: ['string.upper', 'string.sub', 'capitalize'],
  },
  {
    id: 'lua-str-112',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Format Hex Number',
    text: 'Format the number as a 2-digit uppercase hex string.',
    setup: 'local n = 255',
    setupCode: 'local n = 255',
    expected: 'FF',
    sample: 'return string.format("%02X", n)',
    hints: ['%X formats as hex uppercase', '%02 pads to 2 digits'],
    tags: ['string.format', 'hex'],
  },
  {
    id: 'lua-str-113',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Pad String Left',
    text: 'Pad the string with zeros to make it 5 characters long.',
    setup: 'local s = "42"',
    setupCode: 'local s = "42"',
    expected: '00042',
    sample: 'return string.format("%05d", tonumber(s))',
    hints: ['Use %05d for padding', 'Convert string to number first'],
    tags: ['string.format', 'pad'],
  },
  {
    id: 'lua-str-114',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Extract Email Domain',
    text: 'Extract the domain from the email address.',
    setup: 'local email = "user@example.com"',
    setupCode: 'local email = "user@example.com"',
    expected: 'example.com',
    sample: 'return string.match(email, "@(.+)")',
    hints: ['Match everything after @', 'Use capture group'],
    tags: ['string.match', 'capture'],
  },
  {
    id: 'lua-str-115',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Replace First Only',
    text: 'Replace only the first occurrence of "cat" with "dog".',
    setup: 'local s = "cat and cat"',
    setupCode: 'local s = "cat and cat"',
    expected: 'dog and cat',
    sample: 'return (string.gsub(s, "cat", "dog", 1))',
    hints: ['Fourth arg limits replacements', 'Use 1 for first only'],
    tags: ['string.gsub', 'replace'],
  },
  {
    id: 'lua-str-116',
    category: 'String Library',
    difficulty: 'hard',
    title: 'Title Case String',
    text: 'Convert string to title case (capitalize each word).',
    setup: 'local s = "hello world lua"',
    setupCode: 'local s = "hello world lua"',
    expected: 'Hello World Lua',
    sample:
      'return (string.gsub(s, "(%a)([%a]*)", function(a, b) return string.upper(a) .. string.lower(b) end))',
    hints: ['Match word parts separately', 'Uppercase first, lowercase rest'],
    tags: ['string.gsub', 'titlecase'],
  },
  {
    id: 'lua-str-117',
    category: 'String Library',
    difficulty: 'hard',
    title: 'Escape Pattern Characters',
    text: 'Escape all Lua pattern magic characters in the string.',
    setup: 'local s = "a.b*c?"',
    setupCode: 'local s = "a.b*c?"',
    expected: 'a%.b%*c%?',
    sample: 'return (string.gsub(s, "([%.%*%+%-%?%^%$%(%)%[%]%%])", "%%%1"))',
    hints: ['Magic chars: . * + - ? ^ $ ( ) [ ] %', 'Prefix each with %'],
    tags: ['string.gsub', 'escape', 'pattern'],
  },
  {
    id: 'lua-str-118',
    category: 'String Library',
    difficulty: 'hard',
    title: 'Parse Key-Value Pairs',
    text: 'Parse "a=1,b=2,c=3" into a table.',
    setup: 'local s = "a=1,b=2,c=3"',
    setupCode: 'local s = "a=1,b=2,c=3"',
    expected: { a: '1', b: '2', c: '3' },
    sample:
      'local result = {}; for k, v in string.gmatch(s, "(%w+)=(%w+)") do result[k] = v end; return result',
    hints: ['Use multiple captures', 'Match key=value pattern'],
    tags: ['string.gmatch', 'parse', 'capture'],
  },
  {
    id: 'lua-str-119',
    category: 'String Library',
    difficulty: 'hard',
    title: 'Word Wrap Text',
    text: 'Insert newline after every 10 characters.',
    setup: 'local s = "abcdefghijklmnopqrstuvwxyz"',
    setupCode: 'local s = "abcdefghijklmnopqrstuvwxyz"',
    expected: 'abcdefghij\nklmnopqrst\nuvwxyz',
    sample: 'return (string.gsub(s, "(" .. string.rep(".", 10) .. ")", "%1\\n")):gsub("\\n$", "")',
    hints: ['Match groups of 10 chars', 'Add newline after each group'],
    tags: ['string.gsub', 'wrap'],
  },
  {
    id: 'lua-str-120',
    category: 'String Library',
    difficulty: 'easy',
    title: 'Compare Strings Ignore Case',
    text: 'Return true if the strings are equal ignoring case.',
    setup: 'local a = "Hello"\nlocal b = "HELLO"',
    setupCode: 'local a = "Hello"\nlocal b = "HELLO"',
    expected: true,
    sample: 'return string.lower(a) == string.lower(b)',
    hints: ['Convert both to lowercase', 'Then compare'],
    tags: ['string.lower', 'compare'],
  },
  {
    id: 'lua-str-121',
    category: 'String Library',
    difficulty: 'easy',
    title: 'Get Middle Character',
    text: 'Return the middle character of the string (assume odd length).',
    setup: 'local s = "abcde"',
    setupCode: 'local s = "abcde"',
    expected: 'c',
    sample: 'local mid = math.ceil(#s / 2); return string.sub(s, mid, mid)',
    hints: ['Calculate middle index', 'Use sub to extract single char'],
    tags: ['string.sub', 'middle'],
  },
  {
    id: 'lua-str-122',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Remove All Vowels',
    text: 'Remove all vowels from the string.',
    setup: 'local s = "hello world"',
    setupCode: 'local s = "hello world"',
    expected: 'hll wrld',
    sample: 'return (string.gsub(s, "[aeiouAEIOU]", ""))',
    hints: ['Use character class for vowels', 'Replace with empty string'],
    tags: ['string.gsub', 'character class'],
  },
  {
    id: 'lua-str-123',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Extract Numbers',
    text: 'Extract all numbers from the string into a table.',
    setup: 'local s = "a1b23c456"',
    setupCode: 'local s = "a1b23c456"',
    expected: ['1', '23', '456'],
    sample:
      'local result = {}; for n in string.gmatch(s, "%d+") do table.insert(result, n) end; return result',
    hints: ['Use gmatch with %d+', 'Collect all matches'],
    tags: ['string.gmatch', 'extract'],
  },
  {
    id: 'lua-str-124',
    category: 'String Library',
    difficulty: 'hard',
    title: 'Validate Email Format',
    text: 'Return true if the string is a valid email format.',
    setup: 'local email = "test@example.com"',
    setupCode: 'local email = "test@example.com"',
    expected: true,
    sample: 'return string.match(email, "^[%w._]+@[%w]+%.[%w]+$") ~= nil',
    hints: ['Match alphanumeric and special chars', 'Require @ and domain'],
    tags: ['string.match', 'validate', 'email'],
  },

  // ============================================================
  // NEW PROBLEMS - Math Library (50 problems)
  // ============================================================

  {
    id: 'lua-math-100',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Power Operation',
    text: 'Calculate 2 raised to the power of 10.',
    setup: 'local base = 2\nlocal exp = 10',
    setupCode: 'local base = 2\nlocal exp = 10',
    expected: 1024,
    sample: 'return base ^ exp',
    hints: ['Use ^ operator for power', 'Or use math.pow if available'],
    tags: ['math', 'power', 'exponent'],
  },
  {
    id: 'lua-math-101',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Get Pi Value',
    text: 'Return the value of pi (use math.pi).',
    setup: '',
    setupCode: '',
    expected: Math.PI,
    sample: 'return math.pi',
    hints: ['math.pi is a constant', 'Represents mathematical pi'],
    tags: ['math.pi', 'constant'],
  },
  {
    id: 'lua-math-102',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Natural Logarithm',
    text: 'Calculate the natural logarithm of e (should be 1).',
    setup: 'local e = math.exp(1)',
    setupCode: 'local e = math.exp(1)',
    expected: 1,
    sample: 'return math.log(e)',
    hints: ['math.log is natural log', 'ln(e) = 1'],
    tags: ['math.log', 'logarithm'],
  },
  {
    id: 'lua-math-103',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Exponential Function',
    text: 'Calculate e raised to power 0.',
    setup: '',
    setupCode: '',
    expected: 1,
    sample: 'return math.exp(0)',
    hints: ['math.exp(x) calculates e^x', 'e^0 = 1'],
    tags: ['math.exp', 'exponential'],
  },
  {
    id: 'lua-math-104',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Sine of Zero',
    text: 'Calculate the sine of 0.',
    setup: '',
    setupCode: '',
    expected: 0,
    sample: 'return math.sin(0)',
    hints: ['math.sin takes radians', 'sin(0) = 0'],
    tags: ['math.sin', 'trigonometry'],
  },
  {
    id: 'lua-math-105',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Cosine of Zero',
    text: 'Calculate the cosine of 0.',
    setup: '',
    setupCode: '',
    expected: 1,
    sample: 'return math.cos(0)',
    hints: ['math.cos takes radians', 'cos(0) = 1'],
    tags: ['math.cos', 'trigonometry'],
  },
  {
    id: 'lua-math-106',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Degrees to Radians',
    text: 'Convert 180 degrees to radians.',
    setup: 'local degrees = 180',
    setupCode: 'local degrees = 180',
    expected: Math.PI,
    sample: 'return math.rad(degrees)',
    hints: ['math.rad converts degrees to radians', '180 degrees = pi radians'],
    tags: ['math.rad', 'conversion'],
  },
  {
    id: 'lua-math-107',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Radians to Degrees',
    text: 'Convert pi radians to degrees.',
    setup: 'local radians = math.pi',
    setupCode: 'local radians = math.pi',
    expected: 180,
    sample: 'return math.deg(radians)',
    hints: ['math.deg converts radians to degrees', 'pi radians = 180 degrees'],
    tags: ['math.deg', 'conversion'],
  },
  {
    id: 'lua-math-108',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Tangent of Angle',
    text: 'Calculate the tangent of pi/4 radians.',
    setup: 'local angle = math.pi / 4',
    setupCode: 'local angle = math.pi / 4',
    expected: 1,
    sample: 'return math.floor(math.tan(angle) + 0.5)',
    hints: ['math.tan calculates tangent', 'tan(pi/4) = 1'],
    tags: ['math.tan', 'trigonometry'],
  },
  {
    id: 'lua-math-109',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Arc Sine',
    text: 'Calculate the arc sine of 1 in radians.',
    setup: '',
    setupCode: '',
    expected: 1.5707963267948966,
    sample: 'return math.asin(1)',
    hints: ['math.asin is inverse sine', 'Returns radians'],
    tags: ['math.asin', 'trigonometry'],
  },
  {
    id: 'lua-math-110',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Log Base 10',
    text: 'Calculate log base 10 of 1000.',
    setup: 'local n = 1000',
    setupCode: 'local n = 1000',
    expected: 3,
    sample: 'return math.log10(n)',
    hints: ['math.log10 is log base 10', 'log10(1000) = 3'],
    tags: ['math.log10', 'logarithm'],
  },
  {
    id: 'lua-math-111',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Hypotenuse Calculation',
    text: 'Calculate the hypotenuse of a right triangle with sides 3 and 4.',
    setup: 'local a = 3\nlocal b = 4',
    setupCode: 'local a = 3\nlocal b = 4',
    expected: 5,
    sample: 'return math.sqrt(a^2 + b^2)',
    hints: ['Use Pythagorean theorem', 'c = sqrt(a^2 + b^2)'],
    tags: ['math.sqrt', 'pythagorean'],
  },
  {
    id: 'lua-math-112',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Round to Nearest Integer',
    text: 'Round the number to the nearest integer.',
    setup: 'local n = 4.6',
    setupCode: 'local n = 4.6',
    expected: 5,
    sample: 'return math.floor(n + 0.5)',
    hints: ['Add 0.5 then floor', 'Standard rounding technique'],
    tags: ['math.floor', 'round'],
  },
  {
    id: 'lua-math-113',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Get Fractional Part',
    text: 'Return only the fractional part of the number.',
    setup: 'local n = 7.89',
    setupCode: 'local n = 7.89',
    expected: 0.89,
    sample: 'local _, frac = math.modf(n); return math.floor(frac * 100 + 0.5) / 100',
    hints: ['math.modf returns int and frac', 'Second return is fractional'],
    tags: ['math.modf', 'fractional'],
  },
  {
    id: 'lua-math-114',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Check if Positive',
    text: 'Return 1 if positive, -1 if negative, 0 if zero.',
    setup: 'local n = -5',
    setupCode: 'local n = -5',
    expected: -1,
    sample: 'if n > 0 then return 1 elseif n < 0 then return -1 else return 0 end',
    hints: ['Compare with 0', 'Return sign indicator'],
    tags: ['math', 'sign'],
  },
  {
    id: 'lua-math-115',
    category: 'Math Library',
    difficulty: 'hard',
    title: 'Distance Between Points',
    text: 'Calculate Euclidean distance between two points.',
    setup: 'local x1, y1 = 0, 0\nlocal x2, y2 = 3, 4',
    setupCode: 'local x1, y1 = 0, 0\nlocal x2, y2 = 3, 4',
    expected: 5,
    sample: 'return math.sqrt((x2-x1)^2 + (y2-y1)^2)',
    hints: ['Use distance formula', 'sqrt((x2-x1)^2 + (y2-y1)^2)'],
    tags: ['math.sqrt', 'distance'],
  },
  {
    id: 'lua-math-116',
    category: 'Math Library',
    difficulty: 'hard',
    title: 'Angle Between Points',
    text: 'Calculate angle in degrees from origin to point (1, 1).',
    setup: 'local x, y = 1, 1',
    setupCode: 'local x, y = 1, 1',
    expected: 45,
    sample: 'return math.deg(math.atan2(y, x))',
    hints: ['Use atan2 for angle', 'Convert radians to degrees'],
    tags: ['math.atan2', 'math.deg', 'angle'],
  },
  {
    id: 'lua-math-117',
    category: 'Math Library',
    difficulty: 'hard',
    title: 'Factorial Calculation',
    text: 'Calculate factorial of 5.',
    setup: 'local n = 5',
    setupCode: 'local n = 5',
    expected: 120,
    sample: 'local result = 1; for i = 2, n do result = result * i end; return result',
    hints: ['Multiply 1 through n', 'Use a loop'],
    tags: ['math', 'factorial'],
  },
  {
    id: 'lua-math-118',
    category: 'Math Library',
    difficulty: 'hard',
    title: 'Greatest Common Divisor',
    text: 'Calculate GCD of 48 and 18.',
    setup: 'local a, b = 48, 18',
    setupCode: 'local a, b = 48, 18',
    expected: 6,
    sample: 'while b ~= 0 do a, b = b, a % b end; return a',
    hints: ['Use Euclidean algorithm', 'Repeat until remainder is 0'],
    tags: ['math', 'gcd', 'algorithm'],
  },
  {
    id: 'lua-math-119',
    category: 'Math Library',
    difficulty: 'hard',
    title: 'Least Common Multiple',
    text: 'Calculate LCM of 4 and 6.',
    setup: 'local a, b = 4, 6',
    setupCode: 'local a, b = 4, 6',
    expected: 12,
    sample:
      'local function gcd(x, y) while y ~= 0 do x, y = y, x % y end; return x end; return (a * b) / gcd(a, b)',
    hints: ['LCM = (a * b) / GCD', 'Calculate GCD first'],
    tags: ['math', 'lcm', 'algorithm'],
  },
  {
    id: 'lua-math-120',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Check Even Number',
    text: 'Return true if the number is even.',
    setup: 'local n = 42',
    setupCode: 'local n = 42',
    expected: true,
    sample: 'return n % 2 == 0',
    hints: ['Even numbers have remainder 0 when divided by 2', 'Use modulo operator'],
    tags: ['math', 'even', 'modulo'],
  },
  {
    id: 'lua-math-121',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Check Odd Number',
    text: 'Return true if the number is odd.',
    setup: 'local n = 7',
    setupCode: 'local n = 7',
    expected: true,
    sample: 'return n % 2 == 1',
    hints: ['Odd numbers have remainder 1', 'Use modulo operator'],
    tags: ['math', 'odd', 'modulo'],
  },
  {
    id: 'lua-math-122',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Is Perfect Square',
    text: 'Return true if the number is a perfect square.',
    setup: 'local n = 16',
    setupCode: 'local n = 16',
    expected: true,
    sample: 'local root = math.sqrt(n); return root == math.floor(root)',
    hints: ['Take square root', 'Check if result is integer'],
    tags: ['math.sqrt', 'perfect square'],
  },
  {
    id: 'lua-math-123',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Is Power of Two',
    text: 'Return true if the number is a power of 2.',
    setup: 'local n = 32',
    setupCode: 'local n = 32',
    expected: true,
    sample:
      'local log = math.log(n) / math.log(2); return math.abs(log - math.floor(log + 0.5)) < 0.0001',
    hints: ['Use log base 2', 'Check if result is integer'],
    tags: ['math.log', 'power of two'],
  },
  {
    id: 'lua-math-124',
    category: 'Math Library',
    difficulty: 'hard',
    title: 'Prime Check',
    text: 'Return true if the number is prime.',
    setup: 'local n = 17',
    setupCode: 'local n = 17',
    expected: true,
    sample:
      'if n < 2 then return false end; for i = 2, math.sqrt(n) do if n % i == 0 then return false end end; return true',
    hints: ['Check divisibility up to sqrt(n)', 'Return false if any divisor found'],
    tags: ['math', 'prime', 'algorithm'],
  },

  // ============================================================
  // NEW PROBLEMS - Metatables (50 problems)
  // ============================================================

  {
    id: 'lua-meta-100',
    category: 'Metatables',
    difficulty: 'easy',
    title: 'Set Metatable',
    text: 'Set an empty metatable on the table and return the table.',
    setup: 'local t = {1, 2, 3}',
    setupCode: 'local t = {1, 2, 3}',
    expected: [1, 2, 3],
    sample: 'setmetatable(t, {}); return t',
    hints: ['Use setmetatable(t, mt)', 'Returns the table'],
    tags: ['setmetatable', 'basic'],
  },
  {
    id: 'lua-meta-101',
    category: 'Metatables',
    difficulty: 'easy',
    title: 'Get Metatable',
    text: 'Return true if the table has a metatable.',
    setup: 'local t = setmetatable({}, {})',
    setupCode: 'local t = setmetatable({}, {})',
    expected: true,
    sample: 'return getmetatable(t) ~= nil',
    hints: ['Use getmetatable(t)', 'Returns nil if no metatable'],
    tags: ['getmetatable', 'check'],
  },
  {
    id: 'lua-meta-102',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__index Table Fallback',
    text: 'Use __index to provide default value "unknown" for missing keys.',
    setup: 'local defaults = {default = "unknown"}\nlocal t = {}',
    setupCode: 'local defaults = {default = "unknown"}\nlocal t = {}',
    expected: 'unknown',
    sample: 'setmetatable(t, {__index = defaults}); return t.default',
    hints: ['__index is checked for missing keys', 'Can be a table or function'],
    tags: ['__index', 'fallback'],
  },
  {
    id: 'lua-meta-103',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__index Function Fallback',
    text: 'Use __index function to return key name for missing keys.',
    setup: 'local t = {a = 1}',
    setupCode: 'local t = {a = 1}',
    expected: 'missing_x',
    sample:
      'setmetatable(t, {__index = function(tbl, key) return "missing_" .. key end}); return t.x',
    hints: ['__index function receives table and key', 'Return computed value'],
    tags: ['__index', 'function'],
  },
  {
    id: 'lua-meta-104',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__newindex Intercept',
    text: 'Use __newindex to store new keys in a separate table.',
    setup: 'local t = {}\nlocal overflow = {}',
    setupCode: 'local t = {}\nlocal overflow = {}',
    expected: 42,
    sample:
      'setmetatable(t, {__newindex = function(tbl, key, val) overflow[key] = val end}); t.x = 42; return overflow.x',
    hints: ['__newindex intercepts new assignments', 'Store in alternate table'],
    tags: ['__newindex', 'intercept'],
  },
  {
    id: 'lua-meta-105',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__tostring Custom',
    text: 'Use __tostring to return "Table(3)" where 3 is the count.',
    setup: 'local t = {1, 2, 3}',
    setupCode: 'local t = {1, 2, 3}',
    expected: 'Table(3)',
    sample:
      'setmetatable(t, {__tostring = function(tbl) return "Table(" .. #tbl .. ")" end}); return tostring(t)',
    hints: ['__tostring customizes tostring()', 'Return formatted string'],
    tags: ['__tostring', 'format'],
  },
  {
    id: 'lua-meta-106',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__add Operator',
    text: 'Use __add to add corresponding elements of two tables.',
    setup: 'local a = {1, 2, 3}\nlocal b = {4, 5, 6}',
    setupCode: 'local a = {1, 2, 3}\nlocal b = {4, 5, 6}',
    expected: [5, 7, 9],
    sample:
      'local mt = {__add = function(t1, t2) local r = {}; for i = 1, #t1 do r[i] = t1[i] + t2[i] end; return r end}; setmetatable(a, mt); return a + b',
    hints: ['__add defines + operator', 'Return new table with results'],
    tags: ['__add', 'operator'],
  },
  {
    id: 'lua-meta-107',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__sub Operator',
    text: 'Use __sub to subtract corresponding elements.',
    setup: 'local a = {10, 20, 30}\nlocal b = {1, 2, 3}',
    setupCode: 'local a = {10, 20, 30}\nlocal b = {1, 2, 3}',
    expected: [9, 18, 27],
    sample:
      'local mt = {__sub = function(t1, t2) local r = {}; for i = 1, #t1 do r[i] = t1[i] - t2[i] end; return r end}; setmetatable(a, mt); return a - b',
    hints: ['__sub defines - operator', 'Subtract element by element'],
    tags: ['__sub', 'operator'],
  },
  {
    id: 'lua-meta-108',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__mul Scalar Multiply',
    text: 'Use __mul to multiply all elements by a scalar.',
    setup: 'local t = {1, 2, 3}\nlocal scalar = 2',
    setupCode: 'local t = {1, 2, 3}\nlocal scalar = 2',
    expected: [2, 4, 6],
    sample:
      'local mt = {__mul = function(t1, n) local r = {}; for i = 1, #t1 do r[i] = t1[i] * n end; return r end}; setmetatable(t, mt); return t * scalar',
    hints: ['__mul defines * operator', 'Multiply each element'],
    tags: ['__mul', 'operator', 'scalar'],
  },
  {
    id: 'lua-meta-109',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__len Custom Length',
    text: 'Use __len to return double the actual length.',
    setup: 'local t = {1, 2, 3}',
    setupCode: 'local t = {1, 2, 3}',
    expected: 6,
    sample:
      'setmetatable(t, {__len = function(tbl) local count = 0; for _ in pairs(tbl) do count = count + 1 end; return count * 2 end}); return #t',
    hints: ['__len defines # operator', 'Return custom length'],
    tags: ['__len', 'operator'],
  },
  {
    id: 'lua-meta-110',
    category: 'Metatables',
    difficulty: 'hard',
    title: '__call Make Callable',
    text: 'Use __call to make the table callable, returning sum of args.',
    setup: 'local t = {}',
    setupCode: 'local t = {}',
    expected: 6,
    sample:
      'setmetatable(t, {__call = function(tbl, a, b, c) return a + b + c end}); return t(1, 2, 3)',
    hints: ['__call makes table callable', 'First arg is the table itself'],
    tags: ['__call', 'callable'],
  },
  {
    id: 'lua-meta-111',
    category: 'Metatables',
    difficulty: 'hard',
    title: '__eq Equality Check',
    text: 'Use __eq to compare tables by their first element.',
    setup: 'local a = {5, 1, 2}\nlocal b = {5, 3, 4}',
    setupCode: 'local a = {5, 1, 2}\nlocal b = {5, 3, 4}',
    expected: true,
    sample:
      'local mt = {__eq = function(t1, t2) return t1[1] == t2[1] end}; setmetatable(a, mt); setmetatable(b, mt); return a == b',
    hints: ['__eq defines == operator', 'Both tables need same metatable'],
    tags: ['__eq', 'operator', 'equality'],
  },
  {
    id: 'lua-meta-112',
    category: 'Metatables',
    difficulty: 'hard',
    title: '__lt Less Than',
    text: 'Use __lt to compare tables by their length.',
    setup: 'local a = {1, 2}\nlocal b = {1, 2, 3}',
    setupCode: 'local a = {1, 2}\nlocal b = {1, 2, 3}',
    expected: true,
    sample:
      'local mt = {__lt = function(t1, t2) return #t1 < #t2 end}; setmetatable(a, mt); setmetatable(b, mt); return a < b',
    hints: ['__lt defines < operator', 'Compare lengths'],
    tags: ['__lt', 'operator', 'comparison'],
  },
  {
    id: 'lua-meta-113',
    category: 'Metatables',
    difficulty: 'hard',
    title: '__concat String Join',
    text: 'Use __concat to join table elements with separator.',
    setup: 'local t = {"a", "b", "c"}\nlocal sep = "-"',
    setupCode: 'local t = {"a", "b", "c"}\nlocal sep = "-"',
    expected: 'a-b-c',
    sample:
      'local mt = {__concat = function(tbl, s) return table.concat(tbl, s) end}; setmetatable(t, mt); return t .. sep',
    hints: ['__concat defines .. operator', 'Use table.concat inside'],
    tags: ['__concat', 'operator'],
  },
  {
    id: 'lua-meta-114',
    category: 'Metatables',
    difficulty: 'hard',
    title: 'Prototype Chain',
    text: 'Create a prototype chain: child inherits from parent.',
    setup: 'local parent = {greet = "hello"}\nlocal child = {}',
    setupCode: 'local parent = {greet = "hello"}\nlocal child = {}',
    expected: 'hello',
    sample: 'setmetatable(child, {__index = parent}); return child.greet',
    hints: ['__index enables inheritance', 'Child falls back to parent'],
    tags: ['__index', 'inheritance', 'prototype'],
  },
  {
    id: 'lua-meta-115',
    category: 'Metatables',
    difficulty: 'hard',
    title: 'Read-Only Table',
    text: 'Create a read-only proxy that throws error on write.',
    setup: 'local data = {x = 10}',
    setupCode: 'local data = {x = 10}',
    expected: 10,
    sample:
      'local proxy = setmetatable({}, {__index = data, __newindex = function() error("read only") end}); return proxy.x',
    hints: ['Use empty table as proxy', '__newindex prevents writes'],
    tags: ['__newindex', 'readonly', 'proxy'],
  },
  {
    id: 'lua-meta-116',
    category: 'Metatables',
    difficulty: 'easy',
    title: '__unm Negation',
    text: 'Use __unm to negate all elements in the table.',
    setup: 'local t = {1, 2, 3}',
    setupCode: 'local t = {1, 2, 3}',
    expected: [-1, -2, -3],
    sample:
      'setmetatable(t, {__unm = function(tbl) local r = {}; for i, v in ipairs(tbl) do r[i] = -v end; return r end}); return -t',
    hints: ['__unm defines unary - operator', 'Negate each element'],
    tags: ['__unm', 'operator', 'negate'],
  },
  {
    id: 'lua-meta-117',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__div Division',
    text: 'Use __div to divide all elements by a number.',
    setup: 'local t = {10, 20, 30}\nlocal divisor = 10',
    setupCode: 'local t = {10, 20, 30}\nlocal divisor = 10',
    expected: [1, 2, 3],
    sample:
      'setmetatable(t, {__div = function(tbl, n) local r = {}; for i, v in ipairs(tbl) do r[i] = v / n end; return r end}); return t / divisor',
    hints: ['__div defines / operator', 'Divide each element'],
    tags: ['__div', 'operator'],
  },
  {
    id: 'lua-meta-118',
    category: 'Metatables',
    difficulty: 'hard',
    title: 'Default Values Table',
    text: 'Create a table that returns 0 for any missing numeric key.',
    setup: 'local t = {[1] = 10, [3] = 30}',
    setupCode: 'local t = {[1] = 10, [3] = 30}',
    expected: 0,
    sample:
      'setmetatable(t, {__index = function(tbl, key) if type(key) == "number" then return 0 end end}); return t[2]',
    hints: ['Check key type in __index', 'Return 0 for numbers'],
    tags: ['__index', 'default'],
  },
  {
    id: 'lua-meta-119',
    category: 'Metatables',
    difficulty: 'hard',
    title: 'Auto-Vivification',
    text: 'Create a table that auto-creates subtables for missing keys.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample:
      'local function autotable() local mt = {__index = function(t, k) t[k] = setmetatable({}, getmetatable(t)); return t[k] end}; return setmetatable({}, mt) end; local t = autotable(); t.a.b.c = 42; return t.a.b.c',
    hints: ['__index creates new subtable', 'Recursively apply metatable'],
    tags: ['__index', 'autovivification'],
  },

  // ============================================================
  // NEW PROBLEMS - Functions (50 problems)
  // ============================================================

  {
    id: 'lua-func-100',
    category: 'Functions',
    difficulty: 'easy',
    title: 'Define Simple Function',
    text: 'Define a function that returns its argument doubled.',
    setup: '',
    setupCode: '',
    expected: 10,
    sample: 'local function double(x) return x * 2 end; return double(5)',
    hints: ['Use local function syntax', 'Return the computed value'],
    tags: ['function', 'define', 'basic'],
  },
  {
    id: 'lua-func-101',
    category: 'Functions',
    difficulty: 'easy',
    title: 'Anonymous Function',
    text: 'Create an anonymous function that adds two numbers.',
    setup: '',
    setupCode: '',
    expected: 7,
    sample: 'local add = function(a, b) return a + b end; return add(3, 4)',
    hints: ['Assign function to variable', 'No name after function keyword'],
    tags: ['function', 'anonymous'],
  },
  {
    id: 'lua-func-102',
    category: 'Functions',
    difficulty: 'easy',
    title: 'Multiple Return Values',
    text: 'Create a function that returns both min and max of two numbers.',
    setup: '',
    setupCode: '',
    expected: [2, 8],
    sample:
      'local function minmax(a, b) if a < b then return a, b else return b, a end end; local min, max = minmax(8, 2); return {min, max}',
    hints: ['Return multiple values with comma', 'Assign to multiple variables'],
    tags: ['function', 'multiple return'],
  },
  {
    id: 'lua-func-103',
    category: 'Functions',
    difficulty: 'easy',
    title: 'Varargs Function',
    text: 'Create a function that sums any number of arguments.',
    setup: '',
    setupCode: '',
    expected: 15,
    sample:
      'local function sum(...) local total = 0; for _, v in ipairs({...}) do total = total + v end; return total end; return sum(1, 2, 3, 4, 5)',
    hints: ['Use ... for varargs', 'Pack into table with {...}'],
    tags: ['function', 'varargs'],
  },
  {
    id: 'lua-func-104',
    category: 'Functions',
    difficulty: 'easy',
    title: 'Default Parameter',
    text: 'Create a function with a default value of 10 for the second parameter.',
    setup: '',
    setupCode: '',
    expected: 15,
    sample: 'local function add(a, b) b = b or 10; return a + b end; return add(5)',
    hints: ['Use or for default value', 'nil triggers the default'],
    tags: ['function', 'default', 'parameter'],
  },
  {
    id: 'lua-func-105',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Closure Counter',
    text: 'Create a closure that counts how many times it is called.',
    setup: '',
    setupCode: '',
    expected: 3,
    sample:
      'local function makeCounter() local count = 0; return function() count = count + 1; return count end end; local counter = makeCounter(); counter(); counter(); return counter()',
    hints: ['Inner function captures outer variable', 'Variable persists between calls'],
    tags: ['function', 'closure', 'counter'],
  },
  {
    id: 'lua-func-106',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Closure Factory',
    text: 'Create a multiplier factory that returns a function multiplying by n.',
    setup: '',
    setupCode: '',
    expected: 15,
    sample:
      'local function multiplier(n) return function(x) return x * n end end; local triple = multiplier(3); return triple(5)',
    hints: ['Return function that uses n', 'n is captured in closure'],
    tags: ['function', 'closure', 'factory'],
  },
  {
    id: 'lua-func-107',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Function Composition',
    text: 'Create a compose function that combines two functions.',
    setup: 'local function addOne(x) return x + 1 end\nlocal function double(x) return x * 2 end',
    setupCode:
      'local function addOne(x) return x + 1 end\nlocal function double(x) return x * 2 end',
    expected: 8,
    sample:
      'local function compose(f, g) return function(x) return f(g(x)) end end; local addOneThenDouble = compose(double, addOne); return addOneThenDouble(3)',
    hints: ['compose(f, g)(x) = f(g(x))', 'Apply inner function first'],
    tags: ['function', 'composition', 'higher order'],
  },
  {
    id: 'lua-func-108',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Partial Application',
    text: 'Create a partial function that fixes the first argument.',
    setup: 'local function add(a, b) return a + b end',
    setupCode: 'local function add(a, b) return a + b end',
    expected: 15,
    sample:
      'local function partial(f, x) return function(y) return f(x, y) end end; local add10 = partial(add, 10); return add10(5)',
    hints: ['Return function with first arg fixed', 'Closure captures x'],
    tags: ['function', 'partial', 'currying'],
  },
  {
    id: 'lua-func-109',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Memoization',
    text: 'Create a memoized version of a function.',
    setup:
      'local callCount = 0\nlocal function expensive(n) callCount = callCount + 1; return n * n end',
    setupCode:
      'local callCount = 0\nlocal function expensive(n) callCount = callCount + 1; return n * n end',
    expected: 1,
    sample:
      'local function memoize(f) local cache = {}; return function(x) if cache[x] == nil then cache[x] = f(x) end; return cache[x] end end; local memo = memoize(expensive); memo(5); memo(5); memo(5); return callCount',
    hints: ['Store results in cache table', 'Check cache before calling'],
    tags: ['function', 'memoize', 'cache'],
  },
  {
    id: 'lua-func-110',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Recursive Fibonacci',
    text: 'Create a recursive function to calculate fibonacci(6).',
    setup: '',
    setupCode: '',
    expected: 8,
    sample:
      'local function fib(n) if n <= 1 then return n end; return fib(n-1) + fib(n-2) end; return fib(6)',
    hints: ['Base case: n <= 1', 'Recurse with n-1 and n-2'],
    tags: ['function', 'recursion', 'fibonacci'],
  },
  {
    id: 'lua-func-111',
    category: 'Functions',
    difficulty: 'hard',
    title: 'Tail Call Factorial',
    text: 'Create a tail-recursive factorial function.',
    setup: '',
    setupCode: '',
    expected: 120,
    sample:
      'local function factorial(n, acc) acc = acc or 1; if n <= 1 then return acc end; return factorial(n - 1, n * acc) end; return factorial(5)',
    hints: ['Use accumulator parameter', 'Last action is recursive call'],
    tags: ['function', 'tail call', 'factorial'],
  },
  {
    id: 'lua-func-112',
    category: 'Functions',
    difficulty: 'hard',
    title: 'Higher Order Filter',
    text: 'Create a filter function that takes a predicate.',
    setup: 'local nums = {1, 2, 3, 4, 5, 6}',
    setupCode: 'local nums = {1, 2, 3, 4, 5, 6}',
    expected: [2, 4, 6],
    sample:
      'local function filter(t, pred) local r = {}; for _, v in ipairs(t) do if pred(v) then table.insert(r, v) end end; return r end; return filter(nums, function(x) return x % 2 == 0 end)',
    hints: ['Take function as parameter', 'Apply predicate to each element'],
    tags: ['function', 'higher order', 'filter'],
  },
  {
    id: 'lua-func-113',
    category: 'Functions',
    difficulty: 'hard',
    title: 'Higher Order Map',
    text: 'Create a map function that transforms each element.',
    setup: 'local nums = {1, 2, 3, 4}',
    setupCode: 'local nums = {1, 2, 3, 4}',
    expected: [1, 4, 9, 16],
    sample:
      'local function map(t, f) local r = {}; for i, v in ipairs(t) do r[i] = f(v) end; return r end; return map(nums, function(x) return x * x end)',
    hints: ['Apply function to each element', 'Return new table'],
    tags: ['function', 'higher order', 'map'],
  },
  {
    id: 'lua-func-114',
    category: 'Functions',
    difficulty: 'hard',
    title: 'Higher Order Reduce',
    text: 'Create a reduce function that folds a table.',
    setup: 'local nums = {1, 2, 3, 4, 5}',
    setupCode: 'local nums = {1, 2, 3, 4, 5}',
    expected: 15,
    sample:
      'local function reduce(t, f, init) local acc = init; for _, v in ipairs(t) do acc = f(acc, v) end; return acc end; return reduce(nums, function(a, b) return a + b end, 0)',
    hints: ['Accumulate with function', 'Start with initial value'],
    tags: ['function', 'higher order', 'reduce'],
  },
  {
    id: 'lua-func-115',
    category: 'Functions',
    difficulty: 'easy',
    title: 'Select Arguments',
    text: 'Use select to get the number of varargs passed.',
    setup: '',
    setupCode: '',
    expected: 5,
    sample:
      'local function countArgs(...) return select("#", ...) end; return countArgs(1, 2, 3, 4, 5)',
    hints: ['select("#", ...) returns count', 'Useful for varargs'],
    tags: ['function', 'select', 'varargs'],
  },
  {
    id: 'lua-func-116',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Select From Index',
    text: 'Use select to get arguments starting from index 3.',
    setup: '',
    setupCode: '',
    expected: [30, 40, 50],
    sample:
      'local function getFrom3(...) return {select(3, ...)} end; return getFrom3(10, 20, 30, 40, 50)',
    hints: ['select(n, ...) returns from index n', 'Pack result in table'],
    tags: ['function', 'select', 'slice'],
  },
  {
    id: 'lua-func-117',
    category: 'Functions',
    difficulty: 'hard',
    title: 'Curried Add',
    text: 'Create a curried add function: add(a)(b)(c).',
    setup: '',
    setupCode: '',
    expected: 6,
    sample:
      'local function add(a) return function(b) return function(c) return a + b + c end end end; return add(1)(2)(3)',
    hints: ['Return nested functions', 'Each captures its parameter'],
    tags: ['function', 'curry', 'nested'],
  },

  // ============================================================
  // NEW PROBLEMS - Iterators (50 problems)
  // ============================================================

  {
    id: 'lua-iter-100',
    category: 'Iterators',
    difficulty: 'easy',
    title: 'Numeric For Loop',
    text: 'Sum numbers from 1 to 10 using numeric for.',
    setup: '',
    setupCode: '',
    expected: 55,
    sample: 'local sum = 0; for i = 1, 10 do sum = sum + i end; return sum',
    hints: ['for i = start, end do', 'Includes both endpoints'],
    tags: ['for', 'numeric', 'loop'],
  },
  {
    id: 'lua-iter-101',
    category: 'Iterators',
    difficulty: 'easy',
    title: 'Step in For Loop',
    text: 'Sum even numbers from 2 to 10 using step.',
    setup: '',
    setupCode: '',
    expected: 30,
    sample: 'local sum = 0; for i = 2, 10, 2 do sum = sum + i end; return sum',
    hints: ['Third parameter is step', 'for i = 2, 10, 2'],
    tags: ['for', 'step', 'loop'],
  },
  {
    id: 'lua-iter-102',
    category: 'Iterators',
    difficulty: 'easy',
    title: 'Countdown Loop',
    text: 'Create table counting down from 5 to 1.',
    setup: '',
    setupCode: '',
    expected: [5, 4, 3, 2, 1],
    sample: 'local t = {}; for i = 5, 1, -1 do table.insert(t, i) end; return t',
    hints: ['Use negative step', 'for i = 5, 1, -1'],
    tags: ['for', 'countdown', 'loop'],
  },
  {
    id: 'lua-iter-103',
    category: 'Iterators',
    difficulty: 'easy',
    title: 'Basic pairs Usage',
    text: 'Count total entries using pairs.',
    setup: 'local t = {a=1, b=2, c=3, 10, 20}',
    setupCode: 'local t = {a=1, b=2, c=3, 10, 20}',
    expected: 5,
    sample: 'local count = 0; for _ in pairs(t) do count = count + 1 end; return count',
    hints: ['pairs iterates all keys', 'Includes both array and hash'],
    tags: ['pairs', 'count', 'iterator'],
  },
  {
    id: 'lua-iter-104',
    category: 'Iterators',
    difficulty: 'medium',
    title: 'Custom Range Iterator',
    text: 'Create iterator that yields numbers from 1 to n.',
    setup: '',
    setupCode: '',
    expected: [1, 2, 3, 4, 5],
    sample:
      'local function range(n) local i = 0; return function() i = i + 1; if i <= n then return i end end end; local t = {}; for v in range(5) do table.insert(t, v) end; return t',
    hints: ['Return iterator function', 'Closure tracks state'],
    tags: ['iterator', 'custom', 'range'],
  },
  {
    id: 'lua-iter-105',
    category: 'Iterators',
    difficulty: 'medium',
    title: 'Stateless Iterator',
    text: 'Create a stateless iterator for squares.',
    setup: '',
    setupCode: '',
    expected: [1, 4, 9, 16],
    sample:
      'local function squares(max, current) current = current + 1; if current <= max then return current, current * current end end; local t = {}; for i, sq in squares, 4, 0 do t[i] = sq end; return t',
    hints: ['Iterator takes state and control', 'Returns next control and value'],
    tags: ['iterator', 'stateless'],
  },
  {
    id: 'lua-iter-106',
    category: 'Iterators',
    difficulty: 'medium',
    title: 'Chars Iterator',
    text: 'Create iterator that yields each character of a string.',
    setup: 'local s = "Lua"',
    setupCode: 'local s = "Lua"',
    expected: ['L', 'u', 'a'],
    sample:
      'local function chars(str) local i = 0; return function() i = i + 1; if i <= #str then return string.sub(str, i, i) end end end; local t = {}; for c in chars(s) do table.insert(t, c) end; return t',
    hints: ['Iterate over string indices', 'Return substring of length 1'],
    tags: ['iterator', 'string', 'chars'],
  },
  {
    id: 'lua-iter-107',
    category: 'Iterators',
    difficulty: 'medium',
    title: 'Reverse ipairs',
    text: 'Create iterator that iterates array in reverse.',
    setup: 'local t = {1, 2, 3, 4, 5}',
    setupCode: 'local t = {1, 2, 3, 4, 5}',
    expected: [5, 4, 3, 2, 1],
    sample:
      'local function ripairs(t) local i = #t + 1; return function() i = i - 1; if i > 0 then return i, t[i] end end end; local r = {}; for _, v in ripairs(t) do table.insert(r, v) end; return r',
    hints: ['Start from end', 'Decrement index'],
    tags: ['iterator', 'reverse', 'ipairs'],
  },
  {
    id: 'lua-iter-108',
    category: 'Iterators',
    difficulty: 'medium',
    title: 'Filter Iterator',
    text: 'Create iterator that only yields even values.',
    setup: 'local t = {1, 2, 3, 4, 5, 6}',
    setupCode: 'local t = {1, 2, 3, 4, 5, 6}',
    expected: [2, 4, 6],
    sample:
      'local function evens(t) local i = 0; return function() repeat i = i + 1 until i > #t or t[i] % 2 == 0; if i <= #t then return t[i] end end end; local r = {}; for v in evens(t) do table.insert(r, v) end; return r',
    hints: ['Skip non-matching values', 'Use repeat-until or while'],
    tags: ['iterator', 'filter'],
  },
  {
    id: 'lua-iter-109',
    category: 'Iterators',
    difficulty: 'hard',
    title: 'Zip Iterator',
    text: 'Create iterator that pairs elements from two tables.',
    setup: 'local a = {1, 2, 3}\nlocal b = {"a", "b", "c"}',
    setupCode: 'local a = {1, 2, 3}\nlocal b = {"a", "b", "c"}',
    expected: [
      [1, 'a'],
      [2, 'b'],
      [3, 'c'],
    ],
    sample:
      'local function zip(t1, t2) local i = 0; return function() i = i + 1; if i <= #t1 and i <= #t2 then return {t1[i], t2[i]} end end end; local r = {}; for pair in zip(a, b) do table.insert(r, pair) end; return r',
    hints: ['Track single index', 'Return pair from both tables'],
    tags: ['iterator', 'zip'],
  },
  {
    id: 'lua-iter-110',
    category: 'Iterators',
    difficulty: 'hard',
    title: 'Enumerate Iterator',
    text: 'Create iterator that yields index and value pairs.',
    setup: 'local t = {"a", "b", "c"}',
    setupCode: 'local t = {"a", "b", "c"}',
    expected: [
      [1, 'a'],
      [2, 'b'],
      [3, 'c'],
    ],
    sample:
      'local function enumerate(t) local i = 0; return function() i = i + 1; if i <= #t then return i, t[i] end end end; local r = {}; for idx, val in enumerate(t) do table.insert(r, {idx, val}) end; return r',
    hints: ['Similar to ipairs', 'Return both index and value'],
    tags: ['iterator', 'enumerate'],
  },
  {
    id: 'lua-iter-111',
    category: 'Iterators',
    difficulty: 'hard',
    title: 'Take N Iterator',
    text: 'Create iterator wrapper that yields only first n items.',
    setup: 'local t = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10}',
    setupCode: 'local t = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10}',
    expected: [1, 2, 3],
    sample:
      'local function take(t, n) local i = 0; return function() i = i + 1; if i <= n and i <= #t then return t[i] end end end; local r = {}; for v in take(t, 3) do table.insert(r, v) end; return r',
    hints: ['Count iterations', 'Stop after n'],
    tags: ['iterator', 'take', 'limit'],
  },
  {
    id: 'lua-iter-112',
    category: 'Iterators',
    difficulty: 'hard',
    title: 'Skip N Iterator',
    text: 'Create iterator that skips first n items.',
    setup: 'local t = {1, 2, 3, 4, 5}',
    setupCode: 'local t = {1, 2, 3, 4, 5}',
    expected: [4, 5],
    sample:
      'local function skip(t, n) local i = n; return function() i = i + 1; if i <= #t then return t[i] end end end; local r = {}; for v in skip(t, 3) do table.insert(r, v) end; return r',
    hints: ['Start index after n', 'Skip first n elements'],
    tags: ['iterator', 'skip', 'offset'],
  },

  // ============================================================
  // NEW PROBLEMS - Coroutines (50 problems)
  // ============================================================

  {
    id: 'lua-coro-100',
    category: 'Coroutines',
    difficulty: 'easy',
    title: 'Create Coroutine',
    text: 'Create a coroutine that returns 42.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample:
      'local co = coroutine.create(function() return 42 end); local _, result = coroutine.resume(co); return result',
    hints: ['coroutine.create takes a function', 'resume returns status and values'],
    tags: ['coroutine.create', 'basic'],
  },
  {
    id: 'lua-coro-101',
    category: 'Coroutines',
    difficulty: 'easy',
    title: 'Check Coroutine Status',
    text: 'Return the status of a new coroutine.',
    setup: '',
    setupCode: '',
    expected: 'suspended',
    sample: 'local co = coroutine.create(function() end); return coroutine.status(co)',
    hints: ['coroutine.status returns state', 'New coroutines are suspended'],
    tags: ['coroutine.status'],
  },
  {
    id: 'lua-coro-102',
    category: 'Coroutines',
    difficulty: 'easy',
    title: 'Resume Coroutine',
    text: 'Resume a coroutine and check it returns true for success.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local co = coroutine.create(function() end); local ok = coroutine.resume(co); return ok',
    hints: ['resume returns boolean first', 'true means success'],
    tags: ['coroutine.resume'],
  },
  {
    id: 'lua-coro-103',
    category: 'Coroutines',
    difficulty: 'easy',
    title: 'Dead Coroutine Status',
    text: 'Return status of a finished coroutine.',
    setup: '',
    setupCode: '',
    expected: 'dead',
    sample:
      'local co = coroutine.create(function() end); coroutine.resume(co); return coroutine.status(co)',
    hints: ['Finished coroutines are dead', 'Cannot be resumed again'],
    tags: ['coroutine.status', 'dead'],
  },
  {
    id: 'lua-coro-104',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Yield Value',
    text: 'Create coroutine that yields 1, then 2, then returns 3.',
    setup: '',
    setupCode: '',
    expected: [1, 2, 3],
    sample:
      'local co = coroutine.create(function() coroutine.yield(1); coroutine.yield(2); return 3 end); local r = {}; for i = 1, 3 do local _, v = coroutine.resume(co); table.insert(r, v) end; return r',
    hints: ['yield suspends and returns value', 'resume continues from yield'],
    tags: ['coroutine.yield', 'sequence'],
  },
  {
    id: 'lua-coro-105',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Pass Value to Resume',
    text: 'Pass a value into coroutine via resume.',
    setup: '',
    setupCode: '',
    expected: 10,
    sample:
      'local co = coroutine.create(function(x) return x * 2 end); local _, result = coroutine.resume(co, 5); return result',
    hints: ['Arguments to resume go to function', 'First resume passes to function args'],
    tags: ['coroutine.resume', 'arguments'],
  },
  {
    id: 'lua-coro-106',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Resume Returns Yield',
    text: 'Get value from yield in resumed coroutine.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample:
      'local co = coroutine.create(function() local x = coroutine.yield(); return x end); coroutine.resume(co); local _, result = coroutine.resume(co, 42); return result',
    hints: ['yield returns what resume passes', 'Second resume provides yield return'],
    tags: ['coroutine.yield', 'resume'],
  },
  {
    id: 'lua-coro-107',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Coroutine Wrap',
    text: 'Use coroutine.wrap for simpler iteration.',
    setup: '',
    setupCode: '',
    expected: [1, 2, 3],
    sample:
      'local iter = coroutine.wrap(function() for i = 1, 3 do coroutine.yield(i) end end); local r = {}; for i = 1, 3 do table.insert(r, iter()) end; return r',
    hints: ['wrap returns callable function', 'No need for resume'],
    tags: ['coroutine.wrap'],
  },
  {
    id: 'lua-coro-108',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Generator Pattern',
    text: 'Create a generator that yields squares.',
    setup: '',
    setupCode: '',
    expected: [1, 4, 9, 16, 25],
    sample:
      'local function squares(n) return coroutine.wrap(function() for i = 1, n do coroutine.yield(i * i) end end) end; local r = {}; for sq in squares(5) do table.insert(r, sq) end; return r',
    hints: ['wrap works with for-in', 'Yields become iteration values'],
    tags: ['coroutine', 'generator'],
  },
  {
    id: 'lua-coro-109',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Running Coroutine',
    text: 'Get the currently running coroutine.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local co; co = coroutine.create(function() return coroutine.running() == co end); local _, result = coroutine.resume(co); return result',
    hints: ['coroutine.running returns current', 'Returns nil in main thread'],
    tags: ['coroutine.running'],
  },
  {
    id: 'lua-coro-110',
    category: 'Coroutines',
    difficulty: 'hard',
    title: 'Producer Consumer',
    text: 'Implement producer-consumer with coroutines.',
    setup: '',
    setupCode: '',
    expected: [1, 2, 3],
    sample:
      'local results = {}; local producer = coroutine.create(function() for i = 1, 3 do coroutine.yield(i) end end); while coroutine.status(producer) ~= "dead" do local _, val = coroutine.resume(producer); if val then table.insert(results, val) end end; return results',
    hints: ['Producer yields values', 'Consumer resumes to get values'],
    tags: ['coroutine', 'producer', 'consumer'],
  },
  {
    id: 'lua-coro-111',
    category: 'Coroutines',
    difficulty: 'hard',
    title: 'Fibonacci Generator',
    text: 'Create fibonacci generator coroutine.',
    setup: '',
    setupCode: '',
    expected: [1, 1, 2, 3, 5],
    sample:
      'local function fibgen() local a, b = 0, 1; while true do a, b = b, a + b; coroutine.yield(a) end end; local fib = coroutine.wrap(fibgen); local r = {}; for i = 1, 5 do table.insert(r, fib()) end; return r',
    hints: ['Infinite generator', 'Yield each fibonacci number'],
    tags: ['coroutine', 'fibonacci', 'generator'],
  },
  {
    id: 'lua-coro-112',
    category: 'Coroutines',
    difficulty: 'hard',
    title: 'Coroutine Pipeline',
    text: 'Chain coroutines in a pipeline.',
    setup: '',
    setupCode: '',
    expected: [2, 4, 6],
    sample:
      'local function producer() for i = 1, 3 do coroutine.yield(i) end end; local function doubler(src) return function() local v = src(); if v then return v * 2 end end end; local p = coroutine.wrap(producer); local d = doubler(p); local r = {}; for i = 1, 3 do table.insert(r, d()) end; return r',
    hints: ['Chain wrapped coroutines', 'Each stage transforms data'],
    tags: ['coroutine', 'pipeline'],
  },
  {
    id: 'lua-coro-113',
    category: 'Coroutines',
    difficulty: 'hard',
    title: 'Async Simulation',
    text: 'Simulate async task with coroutine.',
    setup: '',
    setupCode: '',
    expected: 'done',
    sample:
      'local task = coroutine.create(function() coroutine.yield("working"); return "done" end); coroutine.resume(task); local _, result = coroutine.resume(task); return result',
    hints: ['Yield simulates waiting', 'Resume continues task'],
    tags: ['coroutine', 'async'],
  },
  {
    id: 'lua-coro-114',
    category: 'Coroutines',
    difficulty: 'easy',
    title: 'Check if Yieldable',
    text: 'Check if current context can yield.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local co = coroutine.create(function() return coroutine.isyieldable() end); local _, result = coroutine.resume(co); return result',
    hints: ['isyieldable checks context', 'True inside coroutine'],
    tags: ['coroutine.isyieldable'],
  },
  {
    id: 'lua-coro-115',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Yield Multiple Values',
    text: 'Yield multiple values from coroutine.',
    setup: '',
    setupCode: '',
    expected: [1, 2, 3],
    sample:
      'local co = coroutine.create(function() coroutine.yield(1, 2, 3) end); local _, a, b, c = coroutine.resume(co); return {a, b, c}',
    hints: ['yield can return multiple', 'resume returns all values'],
    tags: ['coroutine.yield', 'multiple'],
  },

  // ============================================================
  // NEW PROBLEMS - Pattern Matching (50 problems)
  // ============================================================

  {
    id: 'lua-pat-100',
    category: 'Pattern Matching',
    difficulty: 'easy',
    title: 'Match Any Character',
    text: 'Use . to match any single character.',
    setup: 'local s = "abc"',
    setupCode: 'local s = "abc"',
    expected: 'abc',
    sample: 'return string.match(s, "...")',
    hints: ['. matches any character', 'Three dots match three chars'],
    tags: ['pattern', 'dot', 'any'],
  },
  {
    id: 'lua-pat-101',
    category: 'Pattern Matching',
    difficulty: 'easy',
    title: 'Match Whitespace',
    text: 'Extract the whitespace between words.',
    setup: 'local s = "hello   world"',
    setupCode: 'local s = "hello   world"',
    expected: '   ',
    sample: 'return string.match(s, "%s+")',
    hints: ['%s matches whitespace', '+ means one or more'],
    tags: ['pattern', 'whitespace'],
  },
  {
    id: 'lua-pat-102',
    category: 'Pattern Matching',
    difficulty: 'easy',
    title: 'Match Non-Whitespace',
    text: 'Extract the first word (non-whitespace sequence).',
    setup: 'local s = "hello world"',
    setupCode: 'local s = "hello world"',
    expected: 'hello',
    sample: 'return string.match(s, "%S+")',
    hints: ['%S matches non-whitespace', 'Uppercase is complement'],
    tags: ['pattern', 'word'],
  },
  {
    id: 'lua-pat-103',
    category: 'Pattern Matching',
    difficulty: 'easy',
    title: 'Match Alphanumeric',
    text: 'Extract the first alphanumeric sequence.',
    setup: 'local s = "...abc123..."',
    setupCode: 'local s = "...abc123..."',
    expected: 'abc123',
    sample: 'return string.match(s, "%w+")',
    hints: ['%w matches letters and digits', 'Alphanumeric characters'],
    tags: ['pattern', 'alphanumeric'],
  },
  {
    id: 'lua-pat-104',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Character Class Range',
    text: 'Match only lowercase letters.',
    setup: 'local s = "Hello World"',
    setupCode: 'local s = "Hello World"',
    expected: 'ello',
    sample: 'return string.match(s, "[a-z]+")',
    hints: ['[a-z] matches lowercase', 'Range in character class'],
    tags: ['pattern', 'range', 'class'],
  },
  {
    id: 'lua-pat-105',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Negated Character Class',
    text: 'Match sequence of non-digits.',
    setup: 'local s = "abc123def"',
    setupCode: 'local s = "abc123def"',
    expected: 'abc',
    sample: 'return string.match(s, "[^0-9]+")',
    hints: ['[^...] negates class', 'Matches non-matching chars'],
    tags: ['pattern', 'negation', 'class'],
  },
  {
    id: 'lua-pat-106',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Optional Match',
    text: 'Match "color" or "colour".',
    setup: 'local s = "colour"',
    setupCode: 'local s = "colour"',
    expected: 'colour',
    sample: 'return string.match(s, "colou?r")',
    hints: ['? makes previous optional', 'Matches 0 or 1'],
    tags: ['pattern', 'optional'],
  },
  {
    id: 'lua-pat-107',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Shortest Match',
    text: 'Match shortest sequence between < and >.',
    setup: 'local s = "<a><b>"',
    setupCode: 'local s = "<a><b>"',
    expected: 'a',
    sample: 'return string.match(s, "<(.-)>")',
    hints: ['- is non-greedy', 'Matches shortest possible'],
    tags: ['pattern', 'non-greedy', 'lazy'],
  },
  {
    id: 'lua-pat-108',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Anchor Start',
    text: 'Match only if string starts with "Hello".',
    setup: 'local s = "Hello World"',
    setupCode: 'local s = "Hello World"',
    expected: 'Hello',
    sample: 'return string.match(s, "^Hello")',
    hints: ['^ anchors to start', 'Must match at beginning'],
    tags: ['pattern', 'anchor', 'start'],
  },
  {
    id: 'lua-pat-109',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Anchor End',
    text: 'Match only if string ends with "World".',
    setup: 'local s = "Hello World"',
    setupCode: 'local s = "Hello World"',
    expected: 'World',
    sample: 'return string.match(s, "World$")',
    hints: ['$ anchors to end', 'Must match at end'],
    tags: ['pattern', 'anchor', 'end'],
  },
  {
    id: 'lua-pat-110',
    category: 'Pattern Matching',
    difficulty: 'hard',
    title: 'Balanced Match',
    text: 'Match balanced parentheses content.',
    setup: 'local s = "(a(b)c)"',
    setupCode: 'local s = "(a(b)c)"',
    expected: 'a(b)c',
    sample: 'return string.match(s, "%b()")',
    hints: ['%b matches balanced', 'Specify open and close chars'],
    tags: ['pattern', 'balanced'],
  },
  {
    id: 'lua-pat-111',
    category: 'Pattern Matching',
    difficulty: 'hard',
    title: 'Frontier Pattern',
    text: 'Match word starting with capital letter.',
    setup: 'local s = "hello World"',
    setupCode: 'local s = "hello World"',
    expected: 'World',
    sample: 'return string.match(s, "%f[%a][A-Z]%a*")',
    hints: ['%f is frontier pattern', 'Matches position between classes'],
    tags: ['pattern', 'frontier'],
  },
  {
    id: 'lua-pat-112',
    category: 'Pattern Matching',
    difficulty: 'hard',
    title: 'Multiple Captures',
    text: 'Extract date parts from "2024-01-15".',
    setup: 'local s = "2024-01-15"',
    setupCode: 'local s = "2024-01-15"',
    expected: ['2024', '01', '15'],
    sample: 'local y, m, d = string.match(s, "(%d+)-(%d+)-(%d+)"); return {y, m, d}',
    hints: ['Multiple () captures', 'Returns multiple values'],
    tags: ['pattern', 'capture', 'multiple'],
  },
  {
    id: 'lua-pat-113',
    category: 'Pattern Matching',
    difficulty: 'hard',
    title: 'Backreference',
    text: 'Match repeated word like "the the".',
    setup: 'local s = "the the cat"',
    setupCode: 'local s = "the the cat"',
    expected: 'the the',
    sample: 'return string.match(s, "(%w+) %1")',
    hints: ['%1 refers to first capture', 'Must match same text'],
    tags: ['pattern', 'backreference'],
  },
  {
    id: 'lua-pat-114',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Replace with Capture',
    text: 'Swap first and last name.',
    setup: 'local s = "John Doe"',
    setupCode: 'local s = "John Doe"',
    expected: 'Doe, John',
    sample: 'return (string.gsub(s, "(%w+) (%w+)", "%2, %1"))',
    hints: ['Use %1 %2 in replacement', 'Refers to captures'],
    tags: ['pattern', 'gsub', 'swap'],
  },
  {
    id: 'lua-pat-115',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Count Pattern Matches',
    text: 'Count how many words in the string.',
    setup: 'local s = "one two three four"',
    setupCode: 'local s = "one two three four"',
    expected: 4,
    sample: 'local _, count = string.gsub(s, "%w+", ""); return count',
    hints: ['gsub returns count', 'Count is second return value'],
    tags: ['pattern', 'count'],
  },

  // ============================================================
  // NEW PROBLEMS - File I/O (40 problems)
  // ============================================================

  {
    id: 'lua-io-100',
    category: 'File I/O',
    difficulty: 'easy',
    title: 'Open File for Reading',
    text: 'Demonstrate opening a file (conceptually).',
    setup: '',
    setupCode: '',
    expected: 'file',
    sample: 'local f = io.tmpfile(); return type(f)',
    hints: ['io.open returns file handle', 'Returns nil on error'],
    tags: ['io.open', 'read'],
  },
  {
    id: 'lua-io-101',
    category: 'File I/O',
    difficulty: 'easy',
    title: 'Close File Handle',
    text: 'Demonstrate proper file closing.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local f = io.tmpfile(); local ok = f:close(); return ok',
    hints: ['Always close files', 'Returns true on success'],
    tags: ['io.close', 'file'],
  },
  {
    id: 'lua-io-102',
    category: 'File I/O',
    difficulty: 'easy',
    title: 'Write String to File',
    text: 'Write a string to a temporary file.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local f = io.tmpfile(); f:write("hello"); f:seek("set"); return f:read() == "hello"',
    hints: ['file:write writes data', 'Returns file or nil'],
    tags: ['io.write', 'file'],
  },
  {
    id: 'lua-io-103',
    category: 'File I/O',
    difficulty: 'easy',
    title: 'Read All Content',
    text: 'Read entire file content.',
    setup: '',
    setupCode: '',
    expected: 'test',
    sample: 'local f = io.tmpfile(); f:write("test"); f:seek("set"); return f:read("*a")',
    hints: ['*a reads all', 'Returns string'],
    tags: ['io.read', 'all'],
  },
  {
    id: 'lua-io-104',
    category: 'File I/O',
    difficulty: 'medium',
    title: 'Read Line by Line',
    text: 'Read file line by line.',
    setup: '',
    setupCode: '',
    expected: 'line1',
    sample: 'local f = io.tmpfile(); f:write("line1\\nline2"); f:seek("set"); return f:read("*l")',
    hints: ['*l reads one line', 'Strips newline'],
    tags: ['io.read', 'line'],
  },
  {
    id: 'lua-io-105',
    category: 'File I/O',
    difficulty: 'medium',
    title: 'Read Number',
    text: 'Read a number from file.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample: 'local f = io.tmpfile(); f:write("42"); f:seek("set"); return f:read("*n")',
    hints: ['*n reads number', 'Parses numeric value'],
    tags: ['io.read', 'number'],
  },
  {
    id: 'lua-io-106',
    category: 'File I/O',
    difficulty: 'medium',
    title: 'Seek Position',
    text: 'Seek to beginning of file.',
    setup: '',
    setupCode: '',
    expected: 0,
    sample: 'local f = io.tmpfile(); f:write("hello"); return f:seek("set")',
    hints: ['seek("set") goes to start', 'Returns new position'],
    tags: ['io.seek', 'position'],
  },
  {
    id: 'lua-io-107',
    category: 'File I/O',
    difficulty: 'medium',
    title: 'Get Current Position',
    text: 'Get current file position.',
    setup: '',
    setupCode: '',
    expected: 5,
    sample: 'local f = io.tmpfile(); f:write("hello"); return f:seek("cur")',
    hints: ['seek("cur") returns current', 'Position in bytes'],
    tags: ['io.seek', 'current'],
  },
  {
    id: 'lua-io-108',
    category: 'File I/O',
    difficulty: 'medium',
    title: 'Seek from End',
    text: 'Seek to end of file.',
    setup: '',
    setupCode: '',
    expected: 5,
    sample: 'local f = io.tmpfile(); f:write("hello"); return f:seek("end")',
    hints: ['seek("end") goes to end', 'Returns file size'],
    tags: ['io.seek', 'end'],
  },
  {
    id: 'lua-io-109',
    category: 'File I/O',
    difficulty: 'hard',
    title: 'Write Formatted',
    text: 'Write formatted string to file.',
    setup: '',
    setupCode: '',
    expected: 'Value: 42',
    sample:
      'local f = io.tmpfile(); f:write(string.format("Value: %d", 42)); f:seek("set"); return f:read("*a")',
    hints: ['Combine format and write', 'Use string.format'],
    tags: ['io.write', 'format'],
  },
  {
    id: 'lua-io-110',
    category: 'File I/O',
    difficulty: 'hard',
    title: 'Lines Iterator',
    text: 'Use lines iterator to read file.',
    setup: '',
    setupCode: '',
    expected: 2,
    sample:
      'local f = io.tmpfile(); f:write("a\\nb"); f:seek("set"); local count = 0; for _ in f:lines() do count = count + 1 end; return count',
    hints: ['file:lines() is iterator', 'Yields each line'],
    tags: ['io.lines', 'iterator'],
  },
  {
    id: 'lua-io-111',
    category: 'File I/O',
    difficulty: 'easy',
    title: 'Flush Buffer',
    text: 'Flush file buffer.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local f = io.tmpfile(); f:write("test"); return f:flush() == true',
    hints: ['flush writes buffer', 'Ensures data is written'],
    tags: ['io.flush', 'buffer'],
  },
  {
    id: 'lua-io-112',
    category: 'File I/O',
    difficulty: 'medium',
    title: 'Set Buffer Mode',
    text: 'Set line buffering mode.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local f = io.tmpfile(); f:setvbuf("line"); return true',
    hints: ['setvbuf sets buffering', 'line, full, or no'],
    tags: ['io.setvbuf', 'buffer'],
  },
  {
    id: 'lua-io-113',
    category: 'File I/O',
    difficulty: 'hard',
    title: 'Read Fixed Bytes',
    text: 'Read exactly 3 bytes from file.',
    setup: '',
    setupCode: '',
    expected: 'hel',
    sample: 'local f = io.tmpfile(); f:write("hello"); f:seek("set"); return f:read(3)',
    hints: ['Pass number to read', 'Reads that many bytes'],
    tags: ['io.read', 'bytes'],
  },
  {
    id: 'lua-io-114',
    category: 'File I/O',
    difficulty: 'hard',
    title: 'Check File Type',
    text: 'Check if handle is a file.',
    setup: '',
    setupCode: '',
    expected: 'file',
    sample: 'local f = io.tmpfile(); return io.type(f)',
    hints: ['io.type checks handle', 'Returns file or closed file'],
    tags: ['io.type', 'check'],
  },
  {
    id: 'lua-io-115',
    category: 'File I/O',
    difficulty: 'medium',
    title: 'Standard Output',
    text: 'Write to stdout (conceptually).',
    setup: '',
    setupCode: '',
    expected: 'file',
    sample: 'return io.type(io.stdout)',
    hints: ['io.stdout is output handle', 'Usually the console'],
    tags: ['io.stdout', 'standard'],
  },

  // ============================================================
  // NEW PROBLEMS - OS Library (40 problems)
  // ============================================================

  {
    id: 'lua-os-100',
    category: 'OS Library',
    difficulty: 'easy',
    title: 'Get Current Time',
    text: 'Get current time as number.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'return type(os.time()) == "number"',
    hints: ['os.time returns seconds', 'Since Unix epoch'],
    tags: ['os.time', 'timestamp'],
  },
  {
    id: 'lua-os-101',
    category: 'OS Library',
    difficulty: 'easy',
    title: 'Get Clock Time',
    text: 'Get CPU time used.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'return type(os.clock()) == "number"',
    hints: ['os.clock returns CPU seconds', 'Useful for benchmarking'],
    tags: ['os.clock', 'cpu'],
  },
  {
    id: 'lua-os-102',
    category: 'OS Library',
    difficulty: 'easy',
    title: 'Format Date',
    text: 'Format date as YYYY-MM-DD.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local d = os.date("%Y-%m-%d"); return string.match(d, "%d%d%d%d%-%d%d%-%d%d") ~= nil',
    hints: ['os.date formats time', '%Y is 4-digit year'],
    tags: ['os.date', 'format'],
  },
  {
    id: 'lua-os-103',
    category: 'OS Library',
    difficulty: 'easy',
    title: 'Get Year',
    text: 'Get current year.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local year = tonumber(os.date("%Y")); return year >= 2024',
    hints: ['%Y gives 4-digit year', 'Returns string'],
    tags: ['os.date', 'year'],
  },
  {
    id: 'lua-os-104',
    category: 'OS Library',
    difficulty: 'medium',
    title: 'Date Table',
    text: 'Get date components as table.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local t = os.date("*t"); return t.year ~= nil and t.month ~= nil and t.day ~= nil',
    hints: ['*t returns table', 'Contains year, month, day, etc'],
    tags: ['os.date', 'table'],
  },
  {
    id: 'lua-os-105',
    category: 'OS Library',
    difficulty: 'medium',
    title: 'Time from Table',
    text: 'Convert date table to timestamp.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local t = os.time({year=2024, month=1, day=1}); return type(t) == "number"',
    hints: ['os.time takes table', 'Returns timestamp'],
    tags: ['os.time', 'table'],
  },
  {
    id: 'lua-os-106',
    category: 'OS Library',
    difficulty: 'medium',
    title: 'Time Difference',
    text: 'Calculate time difference.',
    setup: '',
    setupCode: '',
    expected: 86400,
    sample:
      'local t1 = os.time({year=2024, month=1, day=1}); local t2 = os.time({year=2024, month=1, day=2}); return os.difftime(t2, t1)',
    hints: ['os.difftime subtracts times', 'Returns seconds'],
    tags: ['os.difftime', 'difference'],
  },
  {
    id: 'lua-os-107',
    category: 'OS Library',
    difficulty: 'medium',
    title: 'Get Day of Week',
    text: 'Get day of week for a date.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local t = os.date("*t", os.time({year=2024, month=1, day=1})); return t.wday >= 1 and t.wday <= 7',
    hints: ['wday is day of week', '1 is Sunday'],
    tags: ['os.date', 'weekday'],
  },
  {
    id: 'lua-os-108',
    category: 'OS Library',
    difficulty: 'medium',
    title: 'Get Environment Variable',
    text: 'Get PATH environment variable.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local path = os.getenv("PATH"); return path ~= nil or true',
    hints: ['os.getenv reads env var', 'Returns nil if not set'],
    tags: ['os.getenv', 'environment'],
  },
  {
    id: 'lua-os-109',
    category: 'OS Library',
    difficulty: 'hard',
    title: 'Format Time HH:MM:SS',
    text: 'Format time as hours:minutes:seconds.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local t = os.date("%H:%M:%S"); return string.match(t, "%d%d:%d%d:%d%d") ~= nil',
    hints: ['%H, %M, %S for time parts', '24-hour format'],
    tags: ['os.date', 'time'],
  },
  {
    id: 'lua-os-110',
    category: 'OS Library',
    difficulty: 'hard',
    title: 'Is Daylight Saving',
    text: 'Check if daylight saving time.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local t = os.date("*t"); return type(t.isdst) == "boolean"',
    hints: ['isdst is boolean', 'Indicates DST status'],
    tags: ['os.date', 'dst'],
  },
  {
    id: 'lua-os-111',
    category: 'OS Library',
    difficulty: 'easy',
    title: 'Get Temporary Filename',
    text: 'Generate a temporary filename.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local name = os.tmpname(); return type(name) == "string"',
    hints: ['os.tmpname generates name', 'Unique each call'],
    tags: ['os.tmpname', 'temp'],
  },
  {
    id: 'lua-os-112',
    category: 'OS Library',
    difficulty: 'medium',
    title: 'Get Month Name',
    text: 'Get abbreviated month name.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local m = os.date("%b"); return #m == 3',
    hints: ['%b is abbreviated month', 'Jan, Feb, etc'],
    tags: ['os.date', 'month'],
  },
  {
    id: 'lua-os-113',
    category: 'OS Library',
    difficulty: 'medium',
    title: 'Get Day of Year',
    text: 'Get day number of year.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local t = os.date("*t"); return t.yday >= 1 and t.yday <= 366',
    hints: ['yday is day of year', '1-365 or 1-366'],
    tags: ['os.date', 'yday'],
  },
  {
    id: 'lua-os-114',
    category: 'OS Library',
    difficulty: 'hard',
    title: 'Add Days to Date',
    text: 'Add 7 days to a timestamp.',
    setup: '',
    setupCode: '',
    expected: 604800,
    sample: 'local t1 = os.time(); local t2 = t1 + (7 * 24 * 60 * 60); return t2 - t1',
    hints: ['Add seconds for days', '86400 seconds per day'],
    tags: ['os.time', 'arithmetic'],
  },

  // ============================================================
  // NEW PROBLEMS - Debug Library (30 problems)
  // ============================================================

  {
    id: 'lua-dbg-100',
    category: 'Debug Library',
    difficulty: 'easy',
    title: 'Get Traceback',
    text: 'Get a traceback string.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'return type(debug.traceback()) == "string"',
    hints: ['debug.traceback returns string', 'Shows call stack'],
    tags: ['debug.traceback', 'stack'],
  },
  {
    id: 'lua-dbg-101',
    category: 'Debug Library',
    difficulty: 'easy',
    title: 'Traceback with Message',
    text: 'Get traceback with custom message.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local tb = debug.traceback("error here"); return string.find(tb, "error here") ~= nil',
    hints: ['First arg is message', 'Prepended to traceback'],
    tags: ['debug.traceback', 'message'],
  },
  {
    id: 'lua-dbg-102',
    category: 'Debug Library',
    difficulty: 'medium',
    title: 'Get Info About Function',
    text: 'Get info about current function.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local function test() return debug.getinfo(1) end; local info = test(); return info.what ~= nil',
    hints: ['debug.getinfo takes level', '1 is current function'],
    tags: ['debug.getinfo', 'function'],
  },
  {
    id: 'lua-dbg-103',
    category: 'Debug Library',
    difficulty: 'medium',
    title: 'Get Function Name',
    text: 'Get name of calling function.',
    setup: '',
    setupCode: '',
    expected: 'test',
    sample: 'local function test() return debug.getinfo(1, "n").name end; return test()',
    hints: ['"n" requests name info', 'Returns name field'],
    tags: ['debug.getinfo', 'name'],
  },
  {
    id: 'lua-dbg-104',
    category: 'Debug Library',
    difficulty: 'medium',
    title: 'Get Source Info',
    text: 'Get source information.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local function test() return debug.getinfo(1, "S").source end; return test() ~= nil',
    hints: ['"S" requests source info', 'Returns source field'],
    tags: ['debug.getinfo', 'source'],
  },
  {
    id: 'lua-dbg-105',
    category: 'Debug Library',
    difficulty: 'medium',
    title: 'Get Line Number',
    text: 'Get current line number.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local function test() return debug.getinfo(1, "l").currentline end; return type(test()) == "number"',
    hints: ['"l" requests line info', 'Returns currentline'],
    tags: ['debug.getinfo', 'line'],
  },
  {
    id: 'lua-dbg-106',
    category: 'Debug Library',
    difficulty: 'hard',
    title: 'Get Local Variable',
    text: 'Get local variable name.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local function test() local x = 1; return debug.getlocal(1, 1) end; return test() ~= nil',
    hints: ['getlocal takes level and index', 'Returns name and value'],
    tags: ['debug.getlocal', 'local'],
  },
  {
    id: 'lua-dbg-107',
    category: 'Debug Library',
    difficulty: 'hard',
    title: 'Set Local Variable',
    text: 'Set a local variable value.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample:
      'local function test() local x = 1; debug.setlocal(1, 1, 42); return x end; return test()',
    hints: ['setlocal modifies local', 'Takes level, index, value'],
    tags: ['debug.setlocal', 'modify'],
  },
  {
    id: 'lua-dbg-108',
    category: 'Debug Library',
    difficulty: 'hard',
    title: 'Get Upvalue',
    text: 'Get function upvalue.',
    setup: '',
    setupCode: '',
    expected: 10,
    sample:
      'local x = 10; local function test() return x end; local _, val = debug.getupvalue(test, 1); return val',
    hints: ['getupvalue accesses closure', 'Returns name and value'],
    tags: ['debug.getupvalue', 'upvalue'],
  },
  {
    id: 'lua-dbg-109',
    category: 'Debug Library',
    difficulty: 'hard',
    title: 'Set Upvalue',
    text: 'Modify function upvalue.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample:
      'local x = 10; local function test() return x end; debug.setupvalue(test, 1, 42); return test()',
    hints: ['setupvalue modifies closure', 'Changes captured variable'],
    tags: ['debug.setupvalue', 'modify'],
  },
  {
    id: 'lua-dbg-110',
    category: 'Debug Library',
    difficulty: 'medium',
    title: 'Count Parameters',
    text: 'Get number of function parameters.',
    setup: '',
    setupCode: '',
    expected: 2,
    sample: 'local function test(a, b) end; return debug.getinfo(test).nparams',
    hints: ['nparams is parameter count', 'From getinfo result'],
    tags: ['debug.getinfo', 'params'],
  },

  // ============================================================
  // NEW PROBLEMS - OOP Patterns (50 problems)
  // ============================================================

  {
    id: 'lua-oop-100',
    category: 'OOP Patterns',
    difficulty: 'easy',
    title: 'Simple Object',
    text: 'Create an object with name property.',
    setup: '',
    setupCode: '',
    expected: 'Alice',
    sample: 'local obj = {name = "Alice"}; return obj.name',
    hints: ['Tables are objects', 'Properties are table keys'],
    tags: ['oop', 'object', 'basic'],
  },
  {
    id: 'lua-oop-101',
    category: 'OOP Patterns',
    difficulty: 'easy',
    title: 'Method Definition',
    text: 'Define a method that returns name.',
    setup: '',
    setupCode: '',
    expected: 'Bob',
    sample:
      'local obj = {name = "Bob"}; function obj:getName() return self.name end; return obj:getName()',
    hints: ['Use : for method syntax', 'self is implicit first arg'],
    tags: ['oop', 'method', 'self'],
  },
  {
    id: 'lua-oop-102',
    category: 'OOP Patterns',
    difficulty: 'easy',
    title: 'Constructor Function',
    text: 'Create a constructor that sets name.',
    setup: '',
    setupCode: '',
    expected: 'Carol',
    sample:
      'local function Person(name) return {name = name} end; local p = Person("Carol"); return p.name',
    hints: ['Factory function pattern', 'Returns new table'],
    tags: ['oop', 'constructor', 'factory'],
  },
  {
    id: 'lua-oop-103',
    category: 'OOP Patterns',
    difficulty: 'medium',
    title: 'Class with Metatable',
    text: 'Create class using metatable __index.',
    setup: '',
    setupCode: '',
    expected: 'Hello',
    sample:
      'local Class = {}; Class.__index = Class; function Class:greet() return "Hello" end; function Class.new() return setmetatable({}, Class) end; local obj = Class.new(); return obj:greet()',
    hints: ['__index enables method lookup', 'new returns instance'],
    tags: ['oop', 'class', 'metatable'],
  },
  {
    id: 'lua-oop-104',
    category: 'OOP Patterns',
    difficulty: 'medium',
    title: 'Instance Properties',
    text: 'Create class with instance properties.',
    setup: '',
    setupCode: '',
    expected: 'Dave',
    sample:
      'local Person = {}; Person.__index = Person; function Person.new(name) return setmetatable({name = name}, Person) end; function Person:getName() return self.name end; local p = Person.new("Dave"); return p:getName()',
    hints: ['Instance data in table', 'Methods in class table'],
    tags: ['oop', 'instance', 'properties'],
  },
  {
    id: 'lua-oop-105',
    category: 'OOP Patterns',
    difficulty: 'medium',
    title: 'Multiple Methods',
    text: 'Class with getter and setter.',
    setup: '',
    setupCode: '',
    expected: 30,
    sample:
      'local Counter = {}; Counter.__index = Counter; function Counter.new() return setmetatable({value = 0}, Counter) end; function Counter:add(n) self.value = self.value + n end; function Counter:get() return self.value end; local c = Counter.new(); c:add(10); c:add(20); return c:get()',
    hints: ['Setter modifies self', 'Getter returns value'],
    tags: ['oop', 'getter', 'setter'],
  },
  {
    id: 'lua-oop-106',
    category: 'OOP Patterns',
    difficulty: 'hard',
    title: 'Simple Inheritance',
    text: 'Create child class that inherits from parent.',
    setup: '',
    setupCode: '',
    expected: 'Animal speaks',
    sample:
      'local Animal = {}; Animal.__index = Animal; function Animal:speak() return "Animal speaks" end; local Dog = setmetatable({}, {__index = Animal}); Dog.__index = Dog; function Dog.new() return setmetatable({}, Dog) end; local d = Dog.new(); return d:speak()',
    hints: ['Child metatable points to parent', 'Creates inheritance chain'],
    tags: ['oop', 'inheritance', 'prototype'],
  },
  {
    id: 'lua-oop-107',
    category: 'OOP Patterns',
    difficulty: 'hard',
    title: 'Override Method',
    text: 'Override parent method in child.',
    setup: '',
    setupCode: '',
    expected: 'Woof',
    sample:
      'local Animal = {}; Animal.__index = Animal; function Animal:speak() return "..." end; local Dog = setmetatable({}, {__index = Animal}); Dog.__index = Dog; function Dog:speak() return "Woof" end; function Dog.new() return setmetatable({}, Dog) end; local d = Dog.new(); return d:speak()',
    hints: ['Define same method in child', 'Child method takes precedence'],
    tags: ['oop', 'override', 'polymorphism'],
  },
  {
    id: 'lua-oop-108',
    category: 'OOP Patterns',
    difficulty: 'hard',
    title: 'Call Super Method',
    text: 'Call parent method from child.',
    setup: '',
    setupCode: '',
    expected: 'Animal says: Woof',
    sample:
      'local Animal = {}; Animal.__index = Animal; function Animal:speak(sound) return "Animal says: " .. sound end; local Dog = setmetatable({}, {__index = Animal}); Dog.__index = Dog; function Dog:speak() return Animal.speak(self, "Woof") end; function Dog.new() return setmetatable({}, Dog) end; local d = Dog.new(); return d:speak()',
    hints: ['Explicitly call parent method', 'Pass self manually'],
    tags: ['oop', 'super', 'inheritance'],
  },
  {
    id: 'lua-oop-109',
    category: 'OOP Patterns',
    difficulty: 'medium',
    title: 'Private Variables',
    text: 'Create private variable with closure.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample:
      'local function Counter() local count = 0; return {add = function(n) count = count + n end, get = function() return count end} end; local c = Counter(); c.add(42); return c.get()',
    hints: ['Local is private', 'Only closures access it'],
    tags: ['oop', 'private', 'closure'],
  },
  {
    id: 'lua-oop-110',
    category: 'OOP Patterns',
    difficulty: 'hard',
    title: 'Mixin Pattern',
    text: 'Add methods from mixin to class.',
    setup: '',
    setupCode: '',
    expected: 'mixed in',
    sample:
      'local Mixin = {mixed = function(self) return "mixed in" end}; local Class = {}; Class.__index = Class; for k, v in pairs(Mixin) do Class[k] = v end; function Class.new() return setmetatable({}, Class) end; local obj = Class.new(); return obj:mixed()',
    hints: ['Copy methods from mixin', 'Extends class capabilities'],
    tags: ['oop', 'mixin', 'composition'],
  },
  {
    id: 'lua-oop-111',
    category: 'OOP Patterns',
    difficulty: 'hard',
    title: 'Singleton Pattern',
    text: 'Implement singleton pattern.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local Singleton = {}; local instance; function Singleton.getInstance() if not instance then instance = {data = 42} end; return instance end; local a = Singleton.getInstance(); local b = Singleton.getInstance(); return a == b',
    hints: ['Store single instance', 'Return same instance always'],
    tags: ['oop', 'singleton', 'pattern'],
  },
  {
    id: 'lua-oop-112',
    category: 'OOP Patterns',
    difficulty: 'medium',
    title: 'Method Chaining',
    text: 'Implement fluent interface with method chaining.',
    setup: '',
    setupCode: '',
    expected: 15,
    sample:
      'local Builder = {}; Builder.__index = Builder; function Builder.new() return setmetatable({value = 0}, Builder) end; function Builder:add(n) self.value = self.value + n; return self end; function Builder:get() return self.value end; return Builder.new():add(5):add(10):get()',
    hints: ['Return self from setters', 'Enables chaining'],
    tags: ['oop', 'chaining', 'fluent'],
  },
  {
    id: 'lua-oop-113',
    category: 'OOP Patterns',
    difficulty: 'hard',
    title: 'Observer Pattern',
    text: 'Implement simple observer pattern.',
    setup: '',
    setupCode: '',
    expected: 2,
    sample:
      'local Subject = {observers = {}, count = 0}; function Subject:subscribe(fn) table.insert(self.observers, fn) end; function Subject:notify() for _, fn in ipairs(self.observers) do fn() end end; Subject:subscribe(function() Subject.count = Subject.count + 1 end); Subject:subscribe(function() Subject.count = Subject.count + 1 end); Subject:notify(); return Subject.count',
    hints: ['Store callbacks', 'Call all on notify'],
    tags: ['oop', 'observer', 'pattern'],
  },
  {
    id: 'lua-oop-114',
    category: 'OOP Patterns',
    difficulty: 'easy',
    title: 'Check Instance Type',
    text: 'Check if object is instance of class.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local Class = {}; Class.__index = Class; function Class.new() return setmetatable({}, Class) end; local obj = Class.new(); return getmetatable(obj) == Class',
    hints: ['Compare metatables', 'Same metatable means same class'],
    tags: ['oop', 'instanceof', 'type'],
  },
  {
    id: 'lua-oop-115',
    category: 'OOP Patterns',
    difficulty: 'medium',
    title: 'Static Method',
    text: 'Define a static class method.',
    setup: '',
    setupCode: '',
    expected: 100,
    sample: 'local Math = {}; function Math.square(x) return x * x end; return Math.square(10)',
    hints: ['Use dot not colon', 'No self parameter'],
    tags: ['oop', 'static', 'method'],
  },

  // ============================================================
  // MORE Table Operations
  // ============================================================

  {
    id: 'lua-tbl-131',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Nested Table Access',
    text: 'Access a deeply nested value.',
    setup: 'local t = {a = {b = {c = 42}}}',
    setupCode: 'local t = {a = {b = {c = 42}}}',
    expected: 42,
    sample: 'return t.a.b.c',
    hints: ['Chain dot notation', 'Access nested levels'],
    tags: ['table', 'nested', 'access'],
  },
  {
    id: 'lua-tbl-132',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Safe Nested Access',
    text: 'Safely access nested value or return nil.',
    setup: 'local t = {a = {}}',
    setupCode: 'local t = {a = {}}',
    expected: null,
    sample: 'return t.a and t.a.b and t.a.b.c',
    hints: ['Use and for safe access', 'Returns nil if path breaks'],
    tags: ['table', 'safe', 'access'],
  },
  {
    id: 'lua-tbl-133',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Table Pack',
    text: 'Pack varargs into a table with n field.',
    setup: '',
    setupCode: '',
    expected: 3,
    sample: 'local function test(...) return table.pack(...).n end; return test(1, 2, 3)',
    hints: ['table.pack includes n field', 'n is the count'],
    tags: ['table.pack', 'varargs'],
  },
  {
    id: 'lua-tbl-134',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Table Unpack',
    text: 'Unpack table into multiple values.',
    setup: 'local t = {10, 20, 30}',
    setupCode: 'local t = {10, 20, 30}',
    expected: 60,
    sample: 'local a, b, c = table.unpack(t); return a + b + c',
    hints: ['table.unpack returns values', 'Assign to multiple vars'],
    tags: ['table.unpack', 'spread'],
  },
  {
    id: 'lua-tbl-135',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Unpack Range',
    text: 'Unpack only elements 2 to 4.',
    setup: 'local t = {1, 2, 3, 4, 5}',
    setupCode: 'local t = {1, 2, 3, 4, 5}',
    expected: 9,
    sample: 'local a, b, c = table.unpack(t, 2, 4); return a + b + c',
    hints: ['Specify start and end indices', 'table.unpack(t, i, j)'],
    tags: ['table.unpack', 'range'],
  },
  {
    id: 'lua-tbl-136',
    category: 'Table Operations',
    difficulty: 'easy',
    title: 'Clear Table',
    text: 'Remove all elements from array table.',
    setup: 'local t = {1, 2, 3, 4, 5}',
    setupCode: 'local t = {1, 2, 3, 4, 5}',
    expected: 0,
    sample: 'for i = 1, #t do t[i] = nil end; return #t',
    hints: ['Set elements to nil', 'Length becomes 0'],
    tags: ['table', 'clear'],
  },
  {
    id: 'lua-tbl-137',
    category: 'Table Operations',
    difficulty: 'medium',
    title: 'Table Move',
    text: 'Move elements from one position to another.',
    setup: 'local t = {1, 2, 3, 4, 5}',
    setupCode: 'local t = {1, 2, 3, 4, 5}',
    expected: [1, 2, 1, 2, 3],
    sample: 'table.move(t, 1, 3, 3); return t',
    hints: ['table.move(src, f, e, dest)', 'Moves elements in place'],
    tags: ['table.move'],
  },
  {
    id: 'lua-tbl-138',
    category: 'Table Operations',
    difficulty: 'hard',
    title: 'Move to Another Table',
    text: 'Move elements from one table to another.',
    setup: 'local src = {1, 2, 3}\nlocal dest = {10, 20}',
    setupCode: 'local src = {1, 2, 3}\nlocal dest = {10, 20}',
    expected: [10, 20, 1, 2, 3],
    sample: 'table.move(src, 1, 3, 3, dest); return dest',
    hints: ['Fifth arg is destination table', 'Elements copied to dest'],
    tags: ['table.move', 'copy'],
  },

  // ============================================================
  // MORE String Library
  // ============================================================

  {
    id: 'lua-str-125',
    category: 'String Library',
    difficulty: 'easy',
    title: 'String Dump (Concept)',
    text: 'Check if string.dump exists.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'return type(string.dump) == "function"',
    hints: ['string.dump serializes functions', 'Returns binary string'],
    tags: ['string.dump'],
  },
  {
    id: 'lua-str-126',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Pack Binary Data',
    text: 'Pack an integer into binary format.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'local packed = string.pack("i4", 42); return #packed == 4',
    hints: ['string.pack creates binary', 'i4 is 4-byte integer'],
    tags: ['string.pack', 'binary'],
  },
  {
    id: 'lua-str-127',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Unpack Binary Data',
    text: 'Unpack an integer from binary.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample:
      'local packed = string.pack("i4", 42); local val = string.unpack("i4", packed); return val',
    hints: ['string.unpack reads binary', 'Returns value(s)'],
    tags: ['string.unpack', 'binary'],
  },
  {
    id: 'lua-str-128',
    category: 'String Library',
    difficulty: 'hard',
    title: 'Pack Multiple Values',
    text: 'Pack two integers.',
    setup: '',
    setupCode: '',
    expected: 8,
    sample: 'local packed = string.pack("i4i4", 10, 20); return #packed',
    hints: ['Concatenate format specifiers', 'Pack multiple values'],
    tags: ['string.pack', 'multiple'],
  },
  {
    id: 'lua-str-129',
    category: 'String Library',
    difficulty: 'easy',
    title: 'Get Pack Size',
    text: 'Get size of packed format.',
    setup: '',
    setupCode: '',
    expected: 4,
    sample: 'return string.packsize("i4")',
    hints: ['packsize returns byte count', 'For fixed-size formats'],
    tags: ['string.packsize'],
  },
  {
    id: 'lua-str-130',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Remove Prefix',
    text: 'Remove prefix "Hello " from string.',
    setup: 'local s = "Hello World"',
    setupCode: 'local s = "Hello World"',
    expected: 'World',
    sample: 'return string.sub(s, 7)',
    hints: ['sub from index to end', 'Omit end index'],
    tags: ['string.sub', 'prefix'],
  },
  {
    id: 'lua-str-131',
    category: 'String Library',
    difficulty: 'medium',
    title: 'Remove Suffix',
    text: 'Remove last 5 characters.',
    setup: 'local s = "Hello World"',
    setupCode: 'local s = "Hello World"',
    expected: 'Hello ',
    sample: 'return string.sub(s, 1, -6)',
    hints: ['Negative end index', 'Excludes from end'],
    tags: ['string.sub', 'suffix'],
  },
  {
    id: 'lua-str-132',
    category: 'String Library',
    difficulty: 'hard',
    title: 'Wrap in Quotes',
    text: 'Use string.format to wrap in double quotes.',
    setup: 'local s = "hello"',
    setupCode: 'local s = "hello"',
    expected: '"hello"',
    sample: 'return string.format("%q", s)',
    hints: ['%q adds quotes', 'Escapes special chars'],
    tags: ['string.format', 'quote'],
  },

  // ============================================================
  // MORE Math Library
  // ============================================================

  {
    id: 'lua-math-125',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Math Huge',
    text: 'Return the value of infinity.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'return math.huge > 10^308',
    hints: ['math.huge is infinity', 'Larger than any finite'],
    tags: ['math.huge', 'infinity'],
  },
  {
    id: 'lua-math-126',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Check NaN',
    text: 'Return true if value is NaN.',
    setup: 'local x = 0/0',
    setupCode: 'local x = 0/0',
    expected: true,
    sample: 'return x ~= x',
    hints: ['NaN is not equal to itself', 'Unique property of NaN'],
    tags: ['math', 'nan'],
  },
  {
    id: 'lua-math-127',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Math Type',
    text: 'Get the type of a number (integer or float).',
    setup: 'local n = 42',
    setupCode: 'local n = 42',
    expected: 'integer',
    sample: 'return math.type(n)',
    hints: ['math.type distinguishes', 'Returns "integer" or "float"'],
    tags: ['math.type'],
  },
  {
    id: 'lua-math-128',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'To Integer',
    text: 'Convert float to integer if possible.',
    setup: 'local n = 42.0',
    setupCode: 'local n = 42.0',
    expected: 42,
    sample: 'return math.tointeger(n)',
    hints: ['math.tointeger converts', 'Returns nil if not exact'],
    tags: ['math.tointeger'],
  },
  {
    id: 'lua-math-129',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Max Integer',
    text: 'Return the maximum integer value.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'return math.maxinteger > 2^62',
    hints: ['math.maxinteger is largest int', 'Platform dependent'],
    tags: ['math.maxinteger'],
  },
  {
    id: 'lua-math-130',
    category: 'Math Library',
    difficulty: 'easy',
    title: 'Min Integer',
    text: 'Return the minimum integer value.',
    setup: '',
    setupCode: '',
    expected: true,
    sample: 'return math.mininteger < -2^62',
    hints: ['math.mininteger is smallest int', 'Negative'],
    tags: ['math.mininteger'],
  },
  {
    id: 'lua-math-131',
    category: 'Math Library',
    difficulty: 'medium',
    title: 'Unsigned Compare',
    text: 'Compare integers as unsigned.',
    setup: 'local a = -1\nlocal b = 1',
    setupCode: 'local a = -1\nlocal b = 1',
    expected: true,
    sample: 'return math.ult(b, a)',
    hints: ['math.ult is unsigned less than', '-1 is large unsigned'],
    tags: ['math.ult', 'unsigned'],
  },

  // ============================================================
  // MORE Metatables
  // ============================================================

  {
    id: 'lua-meta-120',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__mod Operator',
    text: 'Use __mod to implement modulo for tables.',
    setup: 'local t = {10}',
    setupCode: 'local t = {10}',
    expected: 1,
    sample: 'setmetatable(t, {__mod = function(tbl, n) return tbl[1] % n end}); return t % 3',
    hints: ['__mod defines % operator', 'Access table value inside'],
    tags: ['__mod', 'operator'],
  },
  {
    id: 'lua-meta-121',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__pow Operator',
    text: 'Use __pow to implement power for tables.',
    setup: 'local t = {2}',
    setupCode: 'local t = {2}',
    expected: 8,
    sample: 'setmetatable(t, {__pow = function(tbl, n) return tbl[1] ^ n end}); return t ^ 3',
    hints: ['__pow defines ^ operator', 'Returns power result'],
    tags: ['__pow', 'operator'],
  },
  {
    id: 'lua-meta-122',
    category: 'Metatables',
    difficulty: 'hard',
    title: '__pairs Custom Iterator',
    text: 'Customize pairs iteration.',
    setup: 'local t = {a = 1, b = 2}',
    setupCode: 'local t = {a = 1, b = 2}',
    expected: 2,
    sample:
      'setmetatable(t, {__pairs = function(tbl) local keys = {"a", "b"}; local i = 0; return function() i = i + 1; if keys[i] then return keys[i], tbl[keys[i]] end end end}); local count = 0; for k in pairs(t) do count = count + 1 end; return count',
    hints: ['__pairs returns iterator', 'Controls pairs behavior'],
    tags: ['__pairs', 'iterator'],
  },
  {
    id: 'lua-meta-123',
    category: 'Metatables',
    difficulty: 'hard',
    title: '__ipairs Custom Iterator',
    text: 'Customize ipairs iteration.',
    setup: 'local t = {10, 20, 30}',
    setupCode: 'local t = {10, 20, 30}',
    expected: 3,
    sample:
      'setmetatable(t, {__ipairs = function(tbl) local i = 0; return function() i = i + 1; if tbl[i] then return i, tbl[i] end end end}); local count = 0; for _ in ipairs(t) do count = count + 1 end; return count',
    hints: ['__ipairs returns iterator', 'Controls ipairs behavior'],
    tags: ['__ipairs', 'iterator'],
  },
  {
    id: 'lua-meta-124',
    category: 'Metatables',
    difficulty: 'medium',
    title: '__le Operator',
    text: 'Use __le for less-than-or-equal.',
    setup: 'local a = {5}\nlocal b = {5}',
    setupCode: 'local a = {5}\nlocal b = {5}',
    expected: true,
    sample:
      'local mt = {__le = function(t1, t2) return t1[1] <= t2[1] end}; setmetatable(a, mt); setmetatable(b, mt); return a <= b',
    hints: ['__le defines <= operator', 'Both operands need metatable'],
    tags: ['__le', 'operator'],
  },
  {
    id: 'lua-meta-125',
    category: 'Metatables',
    difficulty: 'hard',
    title: '__gc Finalizer',
    text: 'Demonstrate garbage collection finalizer.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local mt = {__gc = function() end}; local t = setmetatable({}, mt); return getmetatable(t).__gc ~= nil',
    hints: ['__gc called on collection', 'Finalizer function'],
    tags: ['__gc', 'finalizer'],
  },

  // ============================================================
  // MORE Functions
  // ============================================================

  {
    id: 'lua-func-118',
    category: 'Functions',
    difficulty: 'easy',
    title: 'Function as Value',
    text: 'Store function in variable and call it.',
    setup: '',
    setupCode: '',
    expected: 10,
    sample: 'local f = function(x) return x * 2 end; return f(5)',
    hints: ['Functions are first-class', 'Store in variable'],
    tags: ['function', 'value'],
  },
  {
    id: 'lua-func-119',
    category: 'Functions',
    difficulty: 'easy',
    title: 'Function in Table',
    text: 'Store function in table and call it.',
    setup: '',
    setupCode: '',
    expected: 15,
    sample: 'local t = {add = function(a, b) return a + b end}; return t.add(7, 8)',
    hints: ['Functions can be table values', 'Call with dot notation'],
    tags: ['function', 'table'],
  },
  {
    id: 'lua-func-120',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Callback Function',
    text: 'Pass function as callback.',
    setup: '',
    setupCode: '',
    expected: [2, 4, 6],
    sample:
      'local function apply(t, f) local r = {}; for i, v in ipairs(t) do r[i] = f(v) end; return r end; return apply({1, 2, 3}, function(x) return x * 2 end)',
    hints: ['Pass function as argument', 'Call it inside'],
    tags: ['function', 'callback'],
  },
  {
    id: 'lua-func-121',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Return Function',
    text: 'Return a function from another function.',
    setup: '',
    setupCode: '',
    expected: 25,
    sample:
      'local function makeSquarer() return function(x) return x * x end end; local sq = makeSquarer(); return sq(5)',
    hints: ['Factory returns function', 'Create specialized functions'],
    tags: ['function', 'return', 'factory'],
  },
  {
    id: 'lua-func-122',
    category: 'Functions',
    difficulty: 'hard',
    title: 'Decorator Pattern',
    text: 'Wrap function to log calls.',
    setup: '',
    setupCode: '',
    expected: 10,
    sample:
      'local function logged(f) return function(...) return f(...) end end; local function add(a, b) return a + b end; local loggedAdd = logged(add); return loggedAdd(4, 6)',
    hints: ['Wrap original function', 'Add behavior before/after'],
    tags: ['function', 'decorator', 'wrap'],
  },
  {
    id: 'lua-func-123',
    category: 'Functions',
    difficulty: 'hard',
    title: 'Once Function',
    text: 'Create function that only runs once.',
    setup: '',
    setupCode: '',
    expected: 42,
    sample:
      'local function once(f) local called = false; local result; return function(...) if not called then called = true; result = f(...) end; return result end end; local init = once(function() return 42 end); init(); init(); return init()',
    hints: ['Track if called', 'Return cached result'],
    tags: ['function', 'once', 'cache'],
  },
  {
    id: 'lua-func-124',
    category: 'Functions',
    difficulty: 'medium',
    title: 'Debounce Concept',
    text: 'Create rate-limited function (simplified).',
    setup: '',
    setupCode: '',
    expected: 1,
    sample:
      'local function throttle(f) local last = 0; return function(...) if os.clock() - last > 0 then last = os.clock(); return f(...) end end end; local count = 0; local inc = throttle(function() count = count + 1 end); inc(); return count',
    hints: ['Track last call time', 'Limit call frequency'],
    tags: ['function', 'throttle'],
  },

  // ============================================================
  // MORE Iterators
  // ============================================================

  {
    id: 'lua-iter-113',
    category: 'Iterators',
    difficulty: 'easy',
    title: 'While Loop Sum',
    text: 'Sum 1 to 5 using while loop.',
    setup: '',
    setupCode: '',
    expected: 15,
    sample: 'local sum = 0; local i = 1; while i <= 5 do sum = sum + i; i = i + 1 end; return sum',
    hints: ['while condition do', 'Manual increment'],
    tags: ['while', 'loop'],
  },
  {
    id: 'lua-iter-114',
    category: 'Iterators',
    difficulty: 'easy',
    title: 'Repeat Until',
    text: 'Use repeat-until to find first even.',
    setup: 'local t = {1, 3, 4, 5}',
    setupCode: 'local t = {1, 3, 4, 5}',
    expected: 4,
    sample:
      'local i = 0; local result; repeat i = i + 1; result = t[i] until result % 2 == 0; return result',
    hints: ['repeat runs at least once', 'until checks condition'],
    tags: ['repeat', 'until', 'loop'],
  },
  {
    id: 'lua-iter-115',
    category: 'Iterators',
    difficulty: 'medium',
    title: 'Break from Loop',
    text: 'Use break to exit loop early.',
    setup: 'local t = {1, 2, 3, 4, 5}',
    setupCode: 'local t = {1, 2, 3, 4, 5}',
    expected: 3,
    sample: 'for i, v in ipairs(t) do if v == 3 then return v end end',
    hints: ['break exits loop', 'Or return from function'],
    tags: ['break', 'loop'],
  },
  {
    id: 'lua-iter-116',
    category: 'Iterators',
    difficulty: 'medium',
    title: 'Nested Loop',
    text: 'Use nested loops to create multiplication.',
    setup: '',
    setupCode: '',
    expected: 12,
    sample:
      'local result = 0; for i = 1, 3 do for j = 1, 4 do result = result + 1 end end; return result',
    hints: ['Outer times inner', '3 * 4 = 12 iterations'],
    tags: ['nested', 'loop'],
  },
  {
    id: 'lua-iter-117',
    category: 'Iterators',
    difficulty: 'hard',
    title: 'Cycle Iterator',
    text: 'Create iterator that cycles through values.',
    setup: 'local t = {"a", "b", "c"}',
    setupCode: 'local t = {"a", "b", "c"}',
    expected: ['a', 'b', 'c', 'a', 'b'],
    sample:
      'local function cycle(t, n) local i = 0; local count = 0; return function() if count >= n then return nil end; count = count + 1; i = (i % #t) + 1; return t[i] end end; local r = {}; for v in cycle(t, 5) do table.insert(r, v) end; return r',
    hints: ['Use modulo to wrap', 'Track iteration count'],
    tags: ['iterator', 'cycle'],
  },
  {
    id: 'lua-iter-118',
    category: 'Iterators',
    difficulty: 'hard',
    title: 'Chain Iterators',
    text: 'Chain two iterators together.',
    setup: 'local a = {1, 2}\nlocal b = {3, 4}',
    setupCode: 'local a = {1, 2}\nlocal b = {3, 4}',
    expected: [1, 2, 3, 4],
    sample:
      'local function chain(t1, t2) local i = 0; local j = 0; return function() i = i + 1; if i <= #t1 then return t1[i] end; j = j + 1; if j <= #t2 then return t2[j] end end end; local r = {}; for v in chain(a, b) do table.insert(r, v) end; return r',
    hints: ['Exhaust first then second', 'Track both indices'],
    tags: ['iterator', 'chain'],
  },

  // ============================================================
  // MORE Coroutines
  // ============================================================

  {
    id: 'lua-coro-116',
    category: 'Coroutines',
    difficulty: 'easy',
    title: 'Simple Yield',
    text: 'Create coroutine that yields once.',
    setup: '',
    setupCode: '',
    expected: 'hello',
    sample:
      'local co = coroutine.create(function() coroutine.yield("hello") end); local _, val = coroutine.resume(co); return val',
    hints: ['yield suspends execution', 'resume gets yielded value'],
    tags: ['coroutine.yield', 'basic'],
  },
  {
    id: 'lua-coro-117',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Stateful Generator',
    text: 'Create stateful counter generator.',
    setup: '',
    setupCode: '',
    expected: [1, 2, 3],
    sample:
      'local function counter() local n = 0; while true do n = n + 1; coroutine.yield(n) end end; local co = coroutine.wrap(counter); local r = {}; for i = 1, 3 do table.insert(r, co()) end; return r',
    hints: ['State persists across yields', 'Infinite generator'],
    tags: ['coroutine', 'stateful'],
  },
  {
    id: 'lua-coro-118',
    category: 'Coroutines',
    difficulty: 'hard',
    title: 'Two-Way Communication',
    text: 'Send and receive values via coroutine.',
    setup: '',
    setupCode: '',
    expected: 10,
    sample:
      'local co = coroutine.create(function() local x = coroutine.yield(); return x * 2 end); coroutine.resume(co); local _, result = coroutine.resume(co, 5); return result',
    hints: ['First resume starts', 'Second resume sends value'],
    tags: ['coroutine', 'communication'],
  },
  {
    id: 'lua-coro-119',
    category: 'Coroutines',
    difficulty: 'hard',
    title: 'Coroutine Error Handling',
    text: 'Handle error in coroutine.',
    setup: '',
    setupCode: '',
    expected: false,
    sample:
      'local co = coroutine.create(function() error("oops") end); local ok = coroutine.resume(co); return ok',
    hints: ['resume returns false on error', 'Error message is second return'],
    tags: ['coroutine', 'error'],
  },
  {
    id: 'lua-coro-120',
    category: 'Coroutines',
    difficulty: 'medium',
    title: 'Range Generator',
    text: 'Create range generator with start, end, step.',
    setup: '',
    setupCode: '',
    expected: [2, 4, 6, 8, 10],
    sample:
      'local function range(start, stop, step) return coroutine.wrap(function() for i = start, stop, step do coroutine.yield(i) end end) end; local r = {}; for v in range(2, 10, 2) do table.insert(r, v) end; return r',
    hints: ['Yield each value in range', 'Use for loop inside'],
    tags: ['coroutine', 'range'],
  },

  // ============================================================
  // MORE Pattern Matching
  // ============================================================

  {
    id: 'lua-pat-116',
    category: 'Pattern Matching',
    difficulty: 'easy',
    title: 'Match Punctuation',
    text: 'Extract first punctuation character.',
    setup: 'local s = "Hello, World!"',
    setupCode: 'local s = "Hello, World!"',
    expected: ',',
    sample: 'return string.match(s, "%p")',
    hints: ['%p matches punctuation', 'Single character'],
    tags: ['pattern', 'punctuation'],
  },
  {
    id: 'lua-pat-117',
    category: 'Pattern Matching',
    difficulty: 'easy',
    title: 'Match Control Character',
    text: 'Check if string contains control chars.',
    setup: 'local s = "hello\\tworld"',
    setupCode: 'local s = "hello\\tworld"',
    expected: true,
    sample: 'return string.match(s, "%c") ~= nil',
    hints: ['%c matches control chars', 'Tab is control char'],
    tags: ['pattern', 'control'],
  },
  {
    id: 'lua-pat-118',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Match Hex Digits',
    text: 'Extract hex number from string.',
    setup: 'local s = "color: #FF00FF"',
    setupCode: 'local s = "color: #FF00FF"',
    expected: 'FF00FF',
    sample: 'return string.match(s, "%x+")',
    hints: ['%x matches hex digits', '0-9 and A-F'],
    tags: ['pattern', 'hex'],
  },
  {
    id: 'lua-pat-119',
    category: 'Pattern Matching',
    difficulty: 'medium',
    title: 'Zero or More Match',
    text: 'Match optional whitespace between words.',
    setup: 'local s = "hello   world"',
    setupCode: 'local s = "hello   world"',
    expected: 'hello   world',
    sample: 'return string.match(s, "%w+%s*%w+")',
    hints: ['* means zero or more', '%s* matches optional space'],
    tags: ['pattern', 'optional'],
  },
  {
    id: 'lua-pat-120',
    category: 'Pattern Matching',
    difficulty: 'hard',
    title: 'Match Quoted String',
    text: 'Extract content between double quotes.',
    setup: 'local s = \'Say "hello" to me\'',
    setupCode: 'local s = \'Say "hello" to me\'',
    expected: 'hello',
    sample: 'return string.match(s, \'"([^"]+)"\')',
    hints: ['Match between quotes', 'Capture content only'],
    tags: ['pattern', 'quotes', 'capture'],
  },
  {
    id: 'lua-pat-121',
    category: 'Pattern Matching',
    difficulty: 'hard',
    title: 'Match URL Domain',
    text: 'Extract domain from URL.',
    setup: 'local url = "https://www.example.com/path"',
    setupCode: 'local url = "https://www.example.com/path"',
    expected: 'www.example.com',
    sample: 'return string.match(url, "https?://([^/]+)")',
    hints: ['Match after protocol', 'Stop at slash'],
    tags: ['pattern', 'url', 'domain'],
  },

  // ============================================================
  // MORE OOP Patterns
  // ============================================================

  {
    id: 'lua-oop-116',
    category: 'OOP Patterns',
    difficulty: 'easy',
    title: 'Self Reference',
    text: 'Use self to access instance property.',
    setup: '',
    setupCode: '',
    expected: 'test',
    sample:
      'local obj = {name = "test"}; function obj:getName() return self.name end; return obj:getName()',
    hints: ['self is implicit first arg', 'References the object'],
    tags: ['oop', 'self'],
  },
  {
    id: 'lua-oop-117',
    category: 'OOP Patterns',
    difficulty: 'medium',
    title: 'Class Variables',
    text: 'Implement class-level variable.',
    setup: '',
    setupCode: '',
    expected: 2,
    sample:
      'local Class = {count = 0}; Class.__index = Class; function Class.new() Class.count = Class.count + 1; return setmetatable({}, Class) end; Class.new(); Class.new(); return Class.count',
    hints: ['Store on class table', 'Shared by all instances'],
    tags: ['oop', 'class variable'],
  },
  {
    id: 'lua-oop-118',
    category: 'OOP Patterns',
    difficulty: 'medium',
    title: 'Destructor Pattern',
    text: 'Implement cleanup method.',
    setup: '',
    setupCode: '',
    expected: 'cleaned',
    sample:
      'local obj = {status = "active"}; function obj:destroy() self.status = "cleaned" end; obj:destroy(); return obj.status',
    hints: ['Call cleanup explicitly', 'Reset or free resources'],
    tags: ['oop', 'destructor'],
  },
  {
    id: 'lua-oop-119',
    category: 'OOP Patterns',
    difficulty: 'hard',
    title: 'Abstract Method',
    text: 'Simulate abstract method that must be overridden.',
    setup: '',
    setupCode: '',
    expected: 'implemented',
    sample:
      'local Base = {}; Base.__index = Base; function Base:method() error("abstract") end; local Child = setmetatable({}, {__index = Base}); Child.__index = Child; function Child:method() return "implemented" end; function Child.new() return setmetatable({}, Child) end; return Child.new():method()',
    hints: ['Base throws error', 'Child provides implementation'],
    tags: ['oop', 'abstract'],
  },
  {
    id: 'lua-oop-120',
    category: 'OOP Patterns',
    difficulty: 'hard',
    title: 'Interface Check',
    text: 'Check if object implements interface.',
    setup: '',
    setupCode: '',
    expected: true,
    sample:
      'local function implements(obj, interface) for k in pairs(interface) do if type(obj[k]) ~= "function" then return false end end; return true end; local obj = {speak = function() end, walk = function() end}; return implements(obj, {speak = true, walk = true})',
    hints: ['Check all required methods', 'Must be functions'],
    tags: ['oop', 'interface'],
  },

  // ========================================
  // BEGINNER FUNDAMENTALS
  // ========================================
  {
    id: 'lua-beginner-loop-001',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Sum Numbers with For Loop',
    text: 'Use a for loop to sum all numbers from 1 to 10.',
    setup: '',
    setupCode: '',
    expected: 55,
    sample: 'local sum = 0; for i = 1, 10 do sum = sum + i end; return sum',
    hints: ['Use local for variables', 'for i = 1, 10 is inclusive range', 'Add each i to sum'],
    tags: ['beginner', 'for-loop', 'sum'],
  },
  {
    id: 'lua-beginner-loop-002',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Count Even Numbers',
    text: 'Use a for loop to count how many even numbers are between 1 and 20.',
    setup: '',
    setupCode: '',
    expected: 10,
    sample:
      'local count = 0; for i = 1, 20 do if i % 2 == 0 then count = count + 1 end end; return count',
    hints: ['Initialize count to 0', 'Use % for modulo', 'Even numbers: i % 2 == 0'],
    tags: ['beginner', 'for-loop', 'conditionals'],
  },
  {
    id: 'lua-beginner-loop-003',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Build a String with Loop',
    text: 'Use a for loop to build a string "123456789" by concatenating numbers 1 through 9.',
    setup: '',
    setupCode: '',
    expected: '123456789',
    sample: 'local s = ""; for i = 1, 9 do s = s .. i end; return s',
    hints: [
      'Start with empty string',
      'Use .. for concatenation',
      'Numbers auto-convert to string',
    ],
    tags: ['beginner', 'for-loop', 'strings'],
  },
  {
    id: 'lua-beginner-cond-001',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Check Positive or Negative',
    text: 'Use if/elseif/else to return "positive" if number is greater than 0, "negative" if less than 0, or "zero".',
    setup: 'local number = 5',
    setupCode: 'local number = 5',
    expected: 'positive',
    sample:
      'if number > 0 then return "positive" elseif number < 0 then return "negative" else return "zero" end',
    hints: ['Use if/elseif/else/end', 'Note: Lua uses elseif (one word)', 'Check > 0 first'],
    tags: ['beginner', 'if-else', 'conditionals'],
  },
  {
    id: 'lua-beginner-cond-002',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Find Maximum of Two',
    text: 'Use if/else to return the larger of two numbers.',
    setup: 'local a, b = 15, 8',
    setupCode: 'local a, b = 15, 8',
    expected: 15,
    sample: 'if a > b then return a else return b end',
    hints: ['Compare a and b', 'Return larger value', 'Or use math.max(a, b)'],
    tags: ['beginner', 'if-else', 'comparison'],
  },
  {
    id: 'lua-beginner-cond-003',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Grade Calculator',
    text: 'Return letter grade: A for score >= 90, B for >= 80, C for >= 70, D for >= 60, F otherwise.',
    setup: 'local score = 85',
    setupCode: 'local score = 85',
    expected: 'B',
    sample:
      'if score >= 90 then return "A" elseif score >= 80 then return "B" elseif score >= 70 then return "C" elseif score >= 60 then return "D" else return "F" end',
    hints: ['Check from highest to lowest', 'Use if/elseif chain', 'End with else for F'],
    tags: ['beginner', 'if-else', 'grades'],
  },
  {
    id: 'lua-beginner-table-001',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Create and Sum Table',
    text: 'Create a table with values 1, 2, 3, 4, 5 and sum all elements.',
    setup: '',
    setupCode: '',
    expected: 15,
    sample:
      'local t = {1, 2, 3, 4, 5}; local sum = 0; for _, v in ipairs(t) do sum = sum + v end; return sum',
    hints: ['Use {} for tables', 'Use ipairs for array iteration', '_ ignores index, v is value'],
    tags: ['beginner', 'table', 'sum'],
  },
  {
    id: 'lua-beginner-table-002',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Insert and Get Length',
    text: 'Create a table {10, 20}, insert 30 at end, and return its length.',
    setup: '',
    setupCode: '',
    expected: 3,
    sample: 'local t = {10, 20}; table.insert(t, 30); return #t',
    hints: ['Use table.insert() to append', 'Use #t for length', '# operator gets table size'],
    tags: ['beginner', 'table', 'insert', 'length'],
  },
  {
    id: 'lua-beginner-table-003',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Create and Access Dictionary',
    text: 'Create a table with key "apple" = 3 and return the value for "apple".',
    setup: '',
    setupCode: '',
    expected: 3,
    sample: 'local t = {apple = 3}; return t.apple',
    hints: [
      'Use key = value syntax',
      'Access with t.key or t["key"]',
      'Tables can be arrays or dicts',
    ],
    tags: ['beginner', 'table', 'dictionary', 'access'],
  },
  {
    id: 'lua-beginner-table-004',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Count Dictionary Entries',
    text: 'Create a table with 3 fruit entries and count the number of keys.',
    setup: '',
    setupCode: '',
    expected: 3,
    sample:
      'local t = {apple = 1, banana = 2, cherry = 3}; local count = 0; for _ in pairs(t) do count = count + 1 end; return count',
    hints: [
      'Use pairs() for dict iteration',
      'Count iterations manually',
      '# only works for array part',
    ],
    tags: ['beginner', 'table', 'dictionary', 'count'],
  },
  {
    id: 'lua-beginner-string-001',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'String Concatenation',
    text: 'Concatenate "Hello, " and "World!" using the .. operator.',
    setup: '',
    setupCode: '',
    expected: 'Hello, World!',
    sample: 'return "Hello, " .. "World!"',
    hints: [
      'Use .. operator for concatenation',
      'Works with variables too',
      'Can chain multiple strings',
    ],
    tags: ['beginner', 'string', 'concatenation'],
  },
  {
    id: 'lua-beginner-string-002',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'String Length',
    text: 'Return the length of the string "Lua" using string.len().',
    setup: '',
    setupCode: '',
    expected: 3,
    sample: 'return string.len("Lua")',
    hints: ['Use string.len() function', 'Or use # operator: #"Lua"', 'Returns number of bytes'],
    tags: ['beginner', 'string', 'length'],
  },
  {
    id: 'lua-beginner-while-001',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Basic While Loop',
    text: 'Use a while loop to sum numbers from 1 to 5 and return the total.',
    setup: '',
    setupCode: '',
    expected: 15,
    sample: 'local sum = 0; local i = 1; while i <= 5 do sum = sum + i; i = i + 1 end; return sum',
    hints: [
      'Use local for variables',
      'while condition do ... end',
      'No ++ operator, use i = i + 1',
    ],
    tags: ['beginner', 'while', 'loop', 'sum'],
  },
  {
    id: 'lua-beginner-table-adv-001',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Table Max Value',
    text: 'Find the maximum value in table {3, 7, 2, 9, 4}.',
    setup: '',
    setupCode: '',
    expected: 9,
    sample:
      'local t = {3, 7, 2, 9, 4}; local m = t[1]; for i = 2, #t do if t[i] > m then m = t[i] end end; return m',
    hints: ['No built-in max for tables', 'Iterate and track maximum', 'Use numeric for loop'],
    tags: ['beginner', 'table', 'max', 'iteration'],
  },
  {
    id: 'lua-beginner-table-adv-002',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Table ipairs Iteration',
    text: 'Use ipairs to sum all values in table {10, 20, 30}.',
    setup: '',
    setupCode: '',
    expected: 60,
    sample:
      'local t = {10, 20, 30}; local sum = 0; for _, v in ipairs(t) do sum = sum + v end; return sum',
    hints: ['ipairs iterates array part', 'Returns index and value', 'Use _ for unused index'],
    tags: ['beginner', 'table', 'ipairs', 'iteration'],
  },
  {
    id: 'lua-beginner-table-adv-003',
    category: 'Beginner Fundamentals',
    difficulty: 'easy',
    title: 'Table pairs Iteration',
    text: 'Use pairs to count all entries in table {a = 1, b = 2, c = 3}.',
    setup: '',
    setupCode: '',
    expected: 3,
    sample:
      'local t = {a = 1, b = 2, c = 3}; local count = 0; for _ in pairs(t) do count = count + 1 end; return count',
    hints: ['pairs iterates all entries', 'Works with string keys', 'Order is not guaranteed'],
    tags: ['beginner', 'table', 'pairs', 'iteration'],
  },
];

export default luaProblems;
